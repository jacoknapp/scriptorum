{{ template "header" . }}
<div class="bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10 p-5">
	<h1 class="text-xl font-semibold mb-4">Settings</h1>
	<form method="post" action="/settings/save" class="grid gap-6">
    
		<!-- Core Configuration Box -->
		<div class="border border-white/20 rounded-lg bg-night-750 p-5">
			<section class="mb-6">
			<h2 class="font-semibold mb-2">General</h2>
			<div class="border border-white/10 rounded p-3">
				<label class="inline-flex items-center gap-2">
					<input type="checkbox" name="debug" {{ if .Cfg.Debug }}checked{{ end }}> Enable debug logging
				</label>
				<div class="text-sm text-slate-400 ml-6">Prints verbose provider/API logs to server stdout (docker logs).</div>
			</div>
			</section>

			<section class="mb-6">
			<h2 class="font-semibold mb-2">Auth</h2>
			<div class="border border-white/10 rounded p-3">
				<label class="inline-flex items-center gap-2"><input type="radio" name="oauth_enabled" value="true" {{if .Cfg.OAuth.Enabled}}checked{{end}}> Enable OAuth</label>
				{{if .Cfg.OAuth.Enabled}}
				<label class="inline-flex items-center gap-2 ml-4"><input type="radio" name="oauth_enabled" value="false"> Disable</label>
				{{else}}
				<label class="inline-flex items-center gap-2 ml-4"><input type="radio" name="oauth_enabled" value="false" checked> Disable</label>
				{{end}}
				<div class="grid md:grid-cols-2 gap-3 mt-3">
					<input name="oauth_issuer" placeholder="Issuer" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.OAuth.Issuer }}">
					<input name="oauth_redirect" placeholder="Redirect URL" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.OAuth.RedirectURL }}">
					<input name="oauth_client_id" placeholder="Client ID" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.OAuth.ClientID }}">
					<input type="password" name="oauth_client_secret" placeholder="Client Secret" autocomplete="new-password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.OAuth.ClientSecret }}">
				</div>
				<div class="grid md:grid-cols-2 gap-3 mt-3">
					<input name="oauth_scopes" placeholder="Scopes (comma-separated)" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ range $i, $s := .Cfg.OAuth.Scopes }}{{ if $i }}, {{ end }}{{$s}}{{ end }}">
					<input name="oauth_username_claim" placeholder="Username claim (e.g. preferred_username)" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.OAuth.UsernameClaim }}">
				</div>
				<div class="mt-3"><label class="inline-flex items-center gap-2"><input type="checkbox" name="oauth_autocreate" {{if .Cfg.OAuth.AutoCreateUsers}}checked{{end}}> Auto-create users on first OAuth login</label></div>
			</div>
			</section>

			<section class="mb-6">
				<h2 class="font-semibold mb-2">Readarr</h2>
				<div class="grid md:grid-cols-2 gap-4">
					<div class="border border-white/10 rounded p-3">
						<h3 class="font-medium">eBooks</h3>
						<input name="ra_ebooks_base" placeholder="Base URL (include http:// or https://)" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.Readarr.Ebooks.BaseURL }}">
						<input type="password" name="ra_ebooks_key" placeholder="API Key" autocomplete="new-password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.Readarr.Ebooks.APIKey }}">
						<div class="mt-2 flex items-center flex-wrap gap-x-4 gap-y-1">
							<label class="inline-flex items-center gap-2 text-white"><input type="radio" name="ra_ebooks_insecure" value="on" {{ if .Cfg.Readarr.Ebooks.InsecureSkipVerify }}checked{{ end }}> Yes</label>
							<label class="inline-flex items-center gap-2 text-white"><input type="radio" name="ra_ebooks_insecure" value="off" {{ if not .Cfg.Readarr.Ebooks.InsecureSkipVerify }}checked{{ end }}> No</label>
							<span class="text-sm text-white">Skip TLS verification (trust self-signed cert)</span>
						</div>
						<label class="block mt-2 text-sm text-white">Quality Profile</label>
						<select id="ra_ebooks_qp" name="ra_ebooks_qp" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" data-server-default="{{ .Cfg.Readarr.Ebooks.DefaultQualityProfileID }}">
							<option value="">(server: {{ .Cfg.Readarr.Ebooks.DefaultQualityProfileID }})</option>
						</select>
						<div class="mt-2 flex items-center gap-2">
							<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testReadarr('ebooks')">Test</button>
							<span id="ra_ebooks_test" class="text-sm text-slate-400">—</span>
						</div>
					</div>
					<div class="border border-white/10 rounded p-3">
						<h3 class="font-medium">Audiobooks</h3>
						<input name="ra_audio_base" placeholder="Base URL (include http:// or https://)" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.Readarr.Audiobooks.BaseURL }}">
						<input type="password" name="ra_audio_key" placeholder="API Key" autocomplete="new-password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Cfg.Readarr.Audiobooks.APIKey }}">
						<div class="mt-2 flex items-center flex-wrap gap-x-4 gap-y-1">
							<label class="inline-flex items-center gap-2 text-white"><input type="radio" name="ra_audio_insecure" value="on" {{ if .Cfg.Readarr.Audiobooks.InsecureSkipVerify }}checked{{ end }}> Yes</label>
							<label class="inline-flex items-center gap-2 text-white"><input type="radio" name="ra_audio_insecure" value="off" {{ if not .Cfg.Readarr.Audiobooks.InsecureSkipVerify }}checked{{ end }}> No</label>
							<span class="text-sm text-white">Skip TLS verification (trust self-signed cert)</span>
						</div>
						<label class="block mt-2 text-sm text-white">Quality Profile</label>
						<select id="ra_audio_qp" name="ra_audio_qp" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" data-server-default="{{ .Cfg.Readarr.Audiobooks.DefaultQualityProfileID }}">
							<option value="">(server: {{ .Cfg.Readarr.Audiobooks.DefaultQualityProfileID }})</option>
						</select>
						<div class="mt-2 flex items-center gap-2">
							<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testReadarr('audiobooks')">Test</button>
							<span id="ra_audio_test" class="text-sm text-slate-400">—</span>
						</div>
					</div>
				</div>
			</section>

			<!-- Save Button -->
			<div>
				<button class="px-4 py-2 rounded-lg bg-royal-600 text-white hover:bg-royal-500">Save</button>
			</div>
		</div>

		<!-- Request Management Box -->
		<div class="border border-white/20 rounded-lg bg-night-750 p-5">
			<section>
			<h2 class="font-semibold mb-2">Request Management</h2>
			<div class="border border-white/10 rounded p-3">
				<p class="text-sm text-slate-400 mb-3">Manage all user requests in the system.</p>
				<div class="flex flex-wrap gap-3">
					<button type="button" 
							class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-500"
							hx-post="/api/v1/requests/approve-all"
							hx-confirm="Are you sure you want to approve ALL pending requests? This will send them to Readarr for processing."
							hx-on="htmx:afterRequest: if(event.detail.successful) { alert('All pending requests have been approved.'); } else { alert('Failed to approve requests.'); }">
						Approve All Requests
					</button>
					<button type="button" 
							class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500"
							hx-delete="/api/v1/requests"
							hx-confirm="Are you sure you want to permanently delete ALL requests? This action cannot be undone."
							hx-on="htmx:afterRequest: if(event.detail.successful) { alert('All requests have been deleted.'); } else { alert('Failed to delete requests.'); }">
						Delete All Requests
					</button>
				</div>
				<div class="text-xs text-slate-400 mt-2">
					<p><strong>Approve All:</strong> Marks all pending requests as "requested" and sends them to Readarr.</p>
					<p><strong>Delete All:</strong> Permanently removes all requests (pending, requested, and declined) from the database.</p>
				</div>
			</div>
			</section>
		</div>
		</form>
</div>
<script>
// populate Readarr quality profile selects
async function loadQPs(kind, selId, serverDefault) {
	const sel = document.getElementById(selId);
	if (!sel) return;
	try {
		const res = await fetch('/api/readarr/profiles?kind='+encodeURIComponent(kind));
		if (!res.ok) return;
		const obj = await res.json();
		// clear existing options except first
		sel.options.length = 1;
		const entries = Object.entries(obj).map(([k,v]) => ({id: parseInt(k,10), name: v}));
		entries.sort((a,b)=>a.id-b.id);
		for (const e of entries) {
			const o = document.createElement('option');
			o.value = e.id;
			o.text = e.id + ' — ' + e.name;
			if (e.id === serverDefault) o.selected = true;
			sel.appendChild(o);
		}
	} catch (e) {
		console.error('qp load', e);
	}
}
document.addEventListener('DOMContentLoaded', ()=>{
	const ebSel = document.getElementById('ra_ebooks_qp');
	const auSel = document.getElementById('ra_audio_qp');
	const ebDef = ebSel ? parseInt(ebSel.getAttribute('data-server-default') || '0', 10) : 0;
	const auDef = auSel ? parseInt(auSel.getAttribute('data-server-default') || '0', 10) : 0;
	loadQPs('ebooks','ra_ebooks_qp', ebDef);
	loadQPs('audiobooks','ra_audio_qp', auDef);
});
// Test Readarr instance and update UI
async function testReadarr(kind) {
	const spanId = kind === 'ebooks' ? 'ra_ebooks_test' : 'ra_audio_test';
	const span = document.getElementById(spanId);
	if (!span) return;
		span.textContent = 'testing...';
	try {
		const res = await fetch('/api/readarr/profiles?kind='+encodeURIComponent(kind));
		if (!res.ok) {
			const txt = await res.text();
			span.innerHTML = '<span class="text-red-700">Error: '+(txt||res.statusText)+'</span>';
			return;
		}
		const obj = await res.json();
		span.innerHTML = '<span class="text-emerald-300">OK ('+Object.keys(obj).length+' profiles)</span>';
	} catch (e) {
		span.innerHTML = '<span class="text-rose-300">Error: '+String(e)+'</span>';
	}
}
</script>
{{ template "footer" . }}