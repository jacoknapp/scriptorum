{{ define "header" }}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Scriptorum</title>
	<link rel="stylesheet" href="/static/styles.css">
		<!-- Use a locally built Tailwind CSS file for production: /static/css/tailwind.css -->
		<link rel="stylesheet" href="/static/css/tailwind.css">
	<script src="https://unpkg.com/htmx.org@1.9.12"></script>
	<link rel="icon" href="/static/icon.svg" type="image/svg+xml" />
	<link rel="manifest" href="/static/site.webmanifest" />
	<meta name="theme-color" content="#0b0b13" />
	<style>html,body{height:100%;}</style>
	<script>
		// Refresh requests table if present when request events occur
		document.addEventListener('htmx:afterOnLoad', function(evt){
			try {
				var trig = evt.detail && evt.detail.xhr && evt.detail.xhr.getResponseHeader('HX-Trigger');
				if (!trig) return;
				var data = JSON.parse(trig);
				if (data['request:created'] || data['request:updated']) {
					var tbl = document.querySelector('#req-table');
					if (tbl) {
						htmx.ajax('GET', '/ui/requests/table', { target: '#req-table', swap: 'innerHTML' });
					}
					// If a request was updated, try to find and update matching search result buttons
					if (data['request:updated']) {
						try {
							var upd = data['request:updated'];
							// find all result forms in current page
							document.querySelectorAll('form[data-isbn13], form[data-isbn10], form[data-asin], form[data-title]').forEach(function(f){
								var fIsbn13 = (f.dataset.isbn13||'').trim();
								var fIsbn10 = (f.dataset.isbn10||'').trim();
								var fAsin = (f.dataset.asin||'').trim();
								var fTitle = (f.dataset.title||'').trim();
								var match = false;
								if (upd.isbn13 && upd.isbn13 === fIsbn13) match = true;
								if (upd.isbn10 && upd.isbn10 === fIsbn10) match = true;
								if (upd.asin && upd.asin === fAsin) match = true;
								if (!match && upd.title && fTitle && upd.title.trim() === fTitle) match = true;
								if (match) {
									// find request buttons inside this form and turn them into Requested state
									var btns = f.querySelectorAll('button');
									btns.forEach(function(b){
										b.textContent = 'Requested ✓';
										b.classList.remove('bg-royal-600','bg-royal-500');
										b.classList.add('bg-emerald-600');
										b.classList.remove('hover:bg-royal-700','hover:bg-royal-600');
										b.disabled = true;
									});
								}
							});
						} catch(e) {}
					}
					// Toast for feedback
					if (data['request:created']) {
						var toast = document.getElementById('toast');
						if (!toast) {
							toast = document.createElement('div');
							toast.id = 'toast';
							toast.style.cssText = 'position:fixed;top:16px;right:16px;z-index:1000;max-width:320px;';
							document.body.appendChild(toast);
						}
						var note = document.createElement('div');
						note.className = 'mb-2 px-3 py-2 rounded-lg shadow-card text-sm bg-emerald-900/30 text-emerald-200 ring-1 ring-emerald-500/30';
						note.innerHTML = 'Request submitted. <a href="/requests" class="underline">Open Requests</a>';
						toast.appendChild(note);
						setTimeout(function(){ note.style.opacity = '0'; note.style.transition = 'opacity .4s'; setTimeout(function(){ note.remove(); }, 400); }, 2500);
					}
				}
			} catch(e) {}
		});

		// Auto-enrich search results with "Unknown Author"
		document.addEventListener('htmx:afterSwap', function(evt){
			try {
				// Only process if this was a search results swap
				var target = evt.detail.target;
				if (!target || target.id !== 'results') return;
				
				// Find all search result items with "Unknown Author"
				var unknownAuthorItems = Array.from(document.querySelectorAll('#results li')).filter(function(li) {
					var authorText = li.querySelector('.text-sm.text-slate-400');
					return authorText && authorText.textContent.trim() === 'Unknown Author';
				});
				
				// Enrich each unknown author item
				unknownAuthorItems.forEach(function(li) {
					enrichUnknownAuthor(li);
				});
			} catch(e) {
				console.error('Error in search results enrichment:', e);
			}
		});

		// Function to enrich a single search result item with unknown author
		function enrichUnknownAuthor(li) {
			try {
				var form = li.querySelector('form');
				if (!form) return;
				
				var ds = form.dataset || {};
				var title = ds.title || form.querySelector('input[name="title"]')?.value || '';
				var isbn13 = ds.isbn13 || form.querySelector('input[name="isbn13"]')?.value || '';
				var isbn10 = ds.isbn10 || form.querySelector('input[name="isbn10"]')?.value || '';
				var asin = ds.asin || form.querySelector('input[name="asin"]')?.value || '';
				
				// Skip if we don't have enough data to search
				if (!title && !isbn13 && !isbn10 && !asin) return;
				
				// Prepare payload for enriched API
				var payload = { title: title };
				if (isbn13) payload.isbn13 = isbn13;
				if (isbn10) payload.isbn10 = isbn10;
				if (asin) payload.asin = asin;
				
				// Make enriched API call
				fetch('/api/v1/book/enriched', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				})
				.then(function(resp) {
					if (!resp.ok) return null;
					return resp.json();
				})
				.then(function(enrichedData) {
					if (!enrichedData || !enrichedData.authors || enrichedData.authors.length === 0) return;
					
					// Update the author display in the search result
					var authorElement = li.querySelector('.text-sm.text-slate-400');
					if (authorElement && authorElement.textContent.trim() === 'Unknown Author') {
						var authorsDisplay = window.formatAuthorsDisplay(enrichedData.authors);
						authorElement.textContent = authorsDisplay;
						
						// Update the hidden author inputs in the form
						var existingAuthorInputs = form.querySelectorAll('input[name="authors"]');
						existingAuthorInputs.forEach(function(input) { input.remove(); });
						
						enrichedData.authors.forEach(function(author) {
							var input = document.createElement('input');
							input.type = 'hidden';
							input.name = 'authors';
							input.value = author;
							form.appendChild(input);
						});
						
						// Update form dataset with properly formatted first author
						if (enrichedData.authors.length > 0) {
							form.dataset.author = window.formatAuthorName(enrichedData.authors[0]);
						}
					}
				})
				.catch(function(err) {
					console.error('Error enriching unknown author:', err);
				});
			} catch(e) {
				console.error('Error in enrichUnknownAuthor:', e);
			}
		}

		// Debounced search with request cancellation
		(function() {
			var searchTimeout = null;
			var currentSearchRequest = null;
			
			window.debouncedSearch = function(query, delay) {
				delay = delay || 600; // Default 600ms delay
				
				console.log('debouncedSearch called with query:', query, 'delay:', delay);
				
				// Clear previous timeout
				if (searchTimeout) {
					console.log('Clearing previous search timeout');
					clearTimeout(searchTimeout);
					searchTimeout = null;
				}
				
				// Cancel previous request if it's still running
				if (currentSearchRequest) {
					console.log('Aborting previous search request');
					currentSearchRequest.abort();
					currentSearchRequest = null;
				}
				
				// Don't search if query is too short
				if (!query || query.trim().length < 2) {
					console.log('Query too short, clearing results');
					var resultsContainer = document.getElementById('results');
					if (resultsContainer) {
						resultsContainer.innerHTML = '';
					}
					return;
				}
				
				console.log('Setting search timeout for', delay, 'ms');
				// Set new timeout
				searchTimeout = setTimeout(function() {
					console.log('Search timeout triggered, starting search for:', query);
					var resultsContainer = document.getElementById('results');
					var indicator = document.getElementById('searchIndicator');
					
					if (indicator) {
						console.log('Showing search indicator');
						indicator.style.display = 'block';
					} else {
						console.warn('Search indicator not found');
					}
					
					// Create new AbortController for this request
					var controller = new AbortController();
					currentSearchRequest = controller;
					
					// Prepare search URL
					var searchForm = document.getElementById('searchForm');
					if (!searchForm) {
						console.error('Search form not found!');
						return;
					}
					
					var formData = new FormData(searchForm);
					formData.set('q', query);
					
					var params = new URLSearchParams(formData);
					var url = '/ui/search?' + params.toString();
					
					console.log('Making search request to:', url);
					
					// Make the search request
					fetch(url, { signal: controller.signal })
						.then(function(response) {
							console.log('Search response status:', response.status);
							if (!response.ok) {
								throw new Error('Search failed: ' + response.status);
							}
							return response.text();
						})
						.then(function(html) {
							console.log('Search completed, updating results');
							if (resultsContainer) {
								resultsContainer.innerHTML = html;
								// Trigger HTMX afterSwap event manually for enrichment
								var event = new CustomEvent('htmx:afterSwap', {
									detail: { target: resultsContainer }
								});
								document.dispatchEvent(event);
							}
						})
						.catch(function(error) {
							if (error.name !== 'AbortError') {
								console.error('Search error:', error);
							} else {
								console.log('Search request aborted');
							}
						})
						.finally(function() {
							console.log('Search request finished, hiding indicator');
							if (indicator) {
								indicator.style.display = 'none';
							}
							currentSearchRequest = null;
						});
				}, delay);
			};
		})();

		// JS fallback if HTMX failed to load
		function scriptorumShowToast(msg, cls){
			var toast = document.getElementById('toast');
			if (!toast) { toast = document.createElement('div'); toast.id = 'toast'; toast.style.cssText = 'position:fixed;top:16px;right:16px;z-index:1000;max-width:320px;'; document.body.appendChild(toast); }
			var note = document.createElement('div');
			note.className = 'mb-2 px-3 py-2 rounded-lg shadow-card text-sm ' + (cls||'bg-emerald-900/30 text-emerald-200 ring-1 ring-emerald-500/30');
			note.textContent = msg;
			toast.appendChild(note);
			setTimeout(function(){ note.style.opacity = '0'; note.style.transition = 'opacity .4s'; setTimeout(function(){ note.remove(); }, 400); }, 2500);
		}
		window.scriptorumRequestFallback = async function(btn, format){
			try{
				var li = btn.closest('li');
				var form = btn.closest('form');
				if (!form) { scriptorumShowToast('No form found for request', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200'); return; }
				var ind = li && li.querySelector('.req-ind'); if (ind) ind.style.display = 'inline';
				btn.classList.add('opacity-60','pointer-events-none');
				var fd = new FormData(form);
				var ds = form.dataset || {};
				var authors = fd.getAll('authors');
				if ((!authors || authors.length === 0) && ds.author) { authors = [ds.author]; }
				var payload = {
					title: (fd.get('title')||ds.title||'').toString(),
					authors: authors,
					isbn10: (fd.get('isbn10')||ds.isbn10||'').toString(),
					isbn13: (fd.get('isbn13')||ds.isbn13||'').toString(),
					asin: (fd.get('asin')||ds.asin||'').toString(),
					format: (format||'ebook'),
					provider: (fd.get('provider')||ds.provider||'').toString()
				};
				// Attach provider_payload if present (do not require a provider label)
				var ppe = (fd.get('provider_payload_ebook')||ds.provider_payload_ebook||'').toString();
				var ppa = (fd.get('provider_payload_audiobook')||ds.provider_payload_audiobook||'').toString();
				var pp = (fd.get('provider_payload')||ds.provider_payload||'').toString();
				if (ppe || ppa || pp) {
					if ((format||'ebook') === 'ebook' && ppe) { payload.provider_payload = ppe; }
					else if ((format||'ebook') === 'audiobook' && ppa) { payload.provider_payload = ppa; }
					else if (pp) { payload.provider_payload = pp; }
				}

				var resp = await fetch('/api/v1/requests', { method: 'POST', body: JSON.stringify(payload), headers: { 'HX-Request':'true', 'Content-Type':'application/json' }, credentials: 'same-origin' });
				if (ind) ind.style.display = 'none';
				if (resp.ok) {
					btn.textContent = 'Requested ✓';
					btn.classList.add('bg-emerald-600');
					btn.classList.remove('bg-royal-600','hover:bg-royal-700','hover:bg-royal-600','hover:bg-royal-500','pointer-events-none');
					scriptorumShowToast('Request submitted. Open Requests to view.');
					var tbl = document.querySelector('#req-table');
					if (tbl) {
						try { const html = await fetch('/ui/requests/table', { credentials: 'same-origin' }).then(r=>r.text()); tbl.innerHTML = html; } catch {}
					}
				} else if (resp.status === 302 || resp.redirected) {
					scriptorumShowToast('Not signed in. Please log in.', 'bg-amber-50 text-amber-800 ring-1 ring-amber-200');
					btn.classList.remove('opacity-60','pointer-events-none');
				} else {
					var txt = await resp.text();
					scriptorumShowToast('Error: ' + (txt||resp.status), 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
					btn.classList.remove('opacity-60','pointer-events-none');
				}
			}catch(err){
				scriptorumShowToast('Network error submitting request', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
				btn.classList.remove('opacity-60','pointer-events-none');
			}
		}
		
		// Helper functions for HTMX request buttons
		window.buildRequestPayload = function(btn, format) {
			var form = btn.closest('form');
			if (!form) return {};
			
			var fd = new FormData(form);
			var ds = form.dataset || {};
			var authors = fd.getAll('authors');
			if ((!authors || authors.length === 0) && ds.author) { authors = [ds.author]; }
			
			var payload = {
				title: (fd.get('title')||ds.title||'').toString(),
				authors: authors,
				isbn10: (fd.get('isbn10')||ds.isbn10||'').toString(),
				isbn13: (fd.get('isbn13')||ds.isbn13||'').toString(),
				asin: (fd.get('asin')||ds.asin||'').toString(),
				format: (format||'ebook'),
				provider: (fd.get('provider')||ds.provider||'').toString()
			};
			
			// Handle format-specific provider payload
			var ppe = (fd.get('provider_payload_ebook')||ds.provider_payload_ebook||'').toString();
			var ppa = (fd.get('provider_payload_audiobook')||ds.provider_payload_audiobook||'').toString();
			var pp = (fd.get('provider_payload')||ds.provider_payload||'').toString();
			if (ppe || ppa || pp) {
				if ((format||'ebook') === 'ebook' && ppe) { payload.provider_payload = ppe; }
				else if ((format||'ebook') === 'audiobook' && ppa) { payload.provider_payload = ppa; }
				else if (pp) { payload.provider_payload = pp; }
			}
			
			return payload;
		}
		
		window.handleRequestResponse = function(event, btn, format) {
			var li = btn.closest('li');
			var ind = li && li.querySelector('.req-ind');
			if (ind) ind.style.display = 'none';
			
			if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
				// Success
				btn.textContent = 'Requested ✓';
				btn.classList.add('bg-emerald-600');
				btn.classList.remove('bg-royal-600','hover:bg-royal-700','hover:bg-royal-600','hover:bg-royal-500','pointer-events-none');
				scriptorumShowToast('Request submitted. Open Requests to view.');
				// Trigger refresh of requests table
				var reqTable = document.querySelector('#req-table');
				if (reqTable && window.htmx) {
					htmx.trigger(reqTable, 'refresh');
				}
			} else if (event.detail.xhr.status === 302 || event.detail.xhr.status === 401) {
				scriptorumShowToast('Not signed in. Please log in.', 'bg-amber-50 text-amber-800 ring-1 ring-amber-200');
				btn.classList.remove('opacity-60','pointer-events-none');
			} else {
				var txt = event.detail.xhr.responseText || event.detail.xhr.status;
				scriptorumShowToast('Error: ' + txt, 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
				btn.classList.remove('opacity-60','pointer-events-none');
			}
		}
		window.scriptorumRequestHtmx = async function(btn, format){
			// Use HTMX for better integration, but fall back to fetch if needed
			if (!window.htmx) {
				return scriptorumRequestFallback(btn, format);
			}
			
			try{
				var li = btn.closest('li');
				var form = btn.closest('form');
				if (!form) { scriptorumShowToast('No form found for request', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200'); return; }
				var ind = li && li.querySelector('.req-ind'); if (ind) ind.style.display = 'inline';
				btn.classList.add('opacity-60','pointer-events-none');
				
				// Build the same payload as the fallback function
				var fd = new FormData(form);
				var ds = form.dataset || {};
				var authors = fd.getAll('authors');
				if ((!authors || authors.length === 0) && ds.author) { authors = [ds.author]; }
				var payload = {
					title: (fd.get('title')||ds.title||'').toString(),
					authors: authors,
					isbn10: (fd.get('isbn10')||ds.isbn10||'').toString(),
					isbn13: (fd.get('isbn13')||ds.isbn13||'').toString(),
					asin: (fd.get('asin')||ds.asin||'').toString(),
					format: (format||'ebook'),
					provider: (fd.get('provider')||ds.provider||'').toString()
				};
				// Attach provider_payload if present (do not require a provider label)
				var ppe = (fd.get('provider_payload_ebook')||ds.provider_payload_ebook||'').toString();
				var ppa = (fd.get('provider_payload_audiobook')||ds.provider_payload_audiobook||'').toString();
				var pp = (fd.get('provider_payload')||ds.provider_payload||'').toString();
				if (ppe || ppa || pp) {
					if ((format||'ebook') === 'ebook' && ppe) { payload.provider_payload = ppe; }
					else if ((format||'ebook') === 'audiobook' && ppa) { payload.provider_payload = ppa; }
					else if (pp) { payload.provider_payload = pp; }
				}

				// Use fetch but with HTMX headers for better integration
				var resp = await fetch('/api/v1/requests', { 
					method: 'POST', 
					body: JSON.stringify(payload), 
					headers: { 
						'HX-Request': 'true', 
						'Content-Type': 'application/json' 
					}, 
					credentials: 'same-origin' 
				});
				
				if (ind) ind.style.display = 'none';
				if (resp.ok) {
					btn.textContent = 'Requested ✓';
					btn.classList.remove('bg-royal-600', 'hover:bg-royal-500', 'hover:bg-royal-700', 'hover:bg-royal-600');
					btn.classList.add('bg-emerald-600');
					btn.disabled = true;
					scriptorumShowToast('Request submitted. Open Requests to view.');
					// Trigger HTMX refresh of requests table if it exists
					var reqTable = document.querySelector('#req-table');
					if (reqTable && window.htmx) {
						htmx.trigger(reqTable, 'refresh');
					}
				} else if (resp.status === 302 || resp.redirected) {
					scriptorumShowToast('Not signed in. Please log in.', 'bg-amber-50 text-amber-800 ring-1 ring-amber-200');
					btn.classList.remove('opacity-60','pointer-events-none');
				} else {
					var txt = await resp.text();
					scriptorumShowToast('Error: ' + (txt||resp.status), 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
					btn.classList.remove('opacity-60','pointer-events-none');
				}
			}catch(err){
				if (ind) ind.style.display = 'none';
				scriptorumShowToast('Network error submitting request', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
				btn.classList.remove('opacity-60','pointer-events-none');
			}
		}
	</script>
</head>
<body class="min-h-screen bg-night-900 text-slate-100">
	<header class="relative text-white">
		<div class="absolute inset-0 bg-gradient-to-r from-royal-900 via-royal-800 to-royal-700"></div>
		<div class="relative max-w-6xl mx-auto px-4 py-4">
			<div class="flex items-center justify-between">
				<a href="/search" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
					<img src="/static/icon.svg" class="w-9 h-9 rounded-xl2 bg-white/10 ring-1 ring-white/15 shadow-card" alt="Scriptorum Icon" />
					<div class="font-semibold tracking-wide">Scriptorum</div>
				</a>
				<!-- Desktop inline nav -->
				<div class="hidden md:flex items-center gap-3 text-sm whitespace-nowrap">
					<a href="/search" class="block px-2 py-1.5 rounded hover:bg-white/10">Search</a>
					<a href="/requests" class="block px-2 py-1.5 rounded hover:bg-white/10">Requests</a>
					{{ if .IsAdmin }}
					<a href="/users" class="block px-2 py-1.5 rounded hover:bg-white/10">Users</a>
					<a href="/notifications" class="block px-2 py-1.5 rounded hover:bg-white/10">Notifications</a>
					<a href="/settings" class="block px-2 py-1.5 rounded hover:bg-white/10">Settings</a>
					{{ end }}
					<a href="/logout" class="inline-block px-3 py-1.5 rounded-lg bg-royal-600 text-white hover:bg-royal-500">Logout</a>
				</div>
				<!-- Mobile hamburger -->
				<button id="navToggle" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40" aria-label="Toggle menu" aria-controls="primaryNav" aria-expanded="false">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M3.75 6.75A.75.75 0 014.5 6h15a.75.75 0 010 1.5h-15a.75.75 0 01-.75-.75zm0 5.25a.75.75 0 01.75-.75h15a.75.75 0 010 1.5h-15a.75.75 0 01-.75-.75zm.75 4.5a.75.75 0 000 1.5h15a.75.75 0 000-1.5h-15z" clip-rule="evenodd" /></svg>
				</button>
			</div>
			<!-- Mobile collapsible nav -->
			<nav id="primaryNav" class="mt-3 md:hidden hidden text-sm">
				<a href="/search" class="block px-2 py-1.5 rounded hover:bg-white/10">Search</a>
				<a href="/requests" class="block px-2 py-1.5 rounded hover:bg-white/10">Requests</a>
				{{ if .IsAdmin }}
				<a href="/users" class="block px-2 py-1.5 rounded hover:bg-white/10">Users</a>
				<a href="/notifications" class="block px-2 py-1.5 rounded hover:bg-white/10">Notifications</a>
				<a href="/settings" class="block px-2 py-1.5 rounded hover:bg-white/10">Settings</a>
				{{ end }}
				<a href="/logout" class="block mt-2 px-3 py-1.5 rounded-lg bg-royal-600 text-white hover:bg-royal-500">Logout</a>
			</nav>
		</div>
	</header>
	<script>
		// Mobile nav toggle
		(function(){
			var t=document.getElementById('navToggle');
			var n=document.getElementById('primaryNav');
			if(!t||!n) return;
			t.addEventListener('click', function(){
				var open = n.classList.contains('block') && !n.classList.contains('hidden');
				if(open){ n.classList.add('hidden'); n.classList.remove('block'); t.setAttribute('aria-expanded','false'); }
				else { n.classList.remove('hidden'); n.classList.add('block'); t.setAttribute('aria-expanded','true'); }
			});
		})();
	</script>
	<main class="max-w-6xl mx-auto px-4 py-6 md:py-8">
{{ end }}

{{ define "footer" }}

	<!-- Global Book Details Modal -->
	<div id="book-modal" class="hidden fixed inset-0 z-50 flex items-center md:items-start justify-center p-4" aria-hidden="true">
		<div id="book-modal-backdrop" class="absolute inset-0 bg-black/60" tabindex="-1"></div>
		<div class="relative max-w-3xl w-full bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10 overflow-hidden z-10 max-h-[90vh] overflow-y-auto">
			<div class="flex gap-4 p-4">
				<img id="book-modal-cover" src="/static/placeholder-cover.svg" class="w-28 h-40 object-cover rounded-md border border-white/10 bg-night-900" alt="Cover" onerror="this.onerror=null; this.src='/static/placeholder-cover.svg';">
				<div class="min-w-0 flex-1">
					<h3 id="book-modal-title" class="font-semibold text-lg truncate"></h3>
					<div id="book-modal-authors" class="text-sm text-slate-400 mt-1"></div>
					<div id="book-modal-meta" class="text-xs text-slate-400 mt-2"></div>
					<!-- Request info section -->
					<div id="book-modal-request-info" class="hidden mt-3 p-2 bg-night-700/50 rounded border border-white/5">
						<div class="text-xs text-slate-300">
							<strong>Requested by:</strong> <span id="book-modal-requester"></span>
						</div>
						<div class="text-xs text-slate-400 mt-1">
							<span>Status:</span> <span id="book-modal-status"></span>
						</div>
					</div>
				</div>
			</div>
			<div class="p-4 border-t border-white/5 text-sm text-slate-200">
				<div id="book-modal-description" class="prose max-w-none text-slate-200"></div>
			</div>
			<!-- User request buttons for search results -->
			<div id="book-modal-user-actions" class="hidden p-3 border-t border-white/5">
				<div class="flex flex-wrap gap-2 justify-end">
					<button id="book-modal-request-ebook" class="px-3 py-1.5 text-xs rounded bg-royal-600 text-white hover:bg-royal-500">Request eBook</button>
					<button id="book-modal-request-audiobook" class="px-3 py-1.5 text-xs rounded bg-royal-600 text-white hover:bg-royal-500">Request Audiobook</button>
				</div>
			</div>
			<!-- Action buttons for requests -->
			<div id="book-modal-actions" class="hidden p-3 border-t border-white/5">
				<div class="flex flex-wrap gap-2 justify-end">
					<button id="book-modal-approve" class="hidden px-3 py-1.5 text-xs rounded bg-royal-600 text-white hover:bg-royal-500">Approve</button>
					<button id="book-modal-attach" class="hidden px-3 py-1.5 text-xs rounded bg-amber-600 text-white hover:bg-amber-500">Attach</button>
					<button id="book-modal-retry" class="hidden px-3 py-1.5 text-xs rounded bg-amber-600 text-white hover:bg-amber-500">Retry</button>
					<button id="book-modal-decline" class="hidden px-3 py-1.5 text-xs rounded bg-orange-600 text-white hover:bg-orange-500">Decline</button>
					<button id="book-modal-delete" class="hidden px-3 py-1.5 text-xs rounded bg-red-600 text-white hover:bg-red-500">Delete</button>
				</div>
			</div>
			<div class="p-3 border-t border-white/5 flex justify-end gap-2">
				<button id="book-modal-close" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10">Close</button>
			</div>
		</div>
	</div>

	<script>
		// Helper: smart-capitalize author names (hyphens, apostrophes, particles, numerals)
		(function(){
			// Common particles to keep lowercased when not the first token
			var LOWER_PARTICLES = ['de','da','del','della','di','du','van','von','der','den','la','le','el','al','the','of','and'];
			var ROMAN_NUMERALS = new Set(['i','ii','iii','iv','v','vi','vii','viii','ix','x','xi','xii','xiii','xiv','xv','xvi','xvii','xviii','xix','xx']);

			function capFirst(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase(); }
			function capHyphenated(token){
				return token.split('-').map(function(part){ return capApostrophe(part); }).join('-');
			}
			function capApostrophe(token){
				// Handle straight and curly apostrophes
				var parts = token.split(/['’]/);
				if (parts.length === 1) return capFirst(token);
				return parts.map(function(p, idx){
					return idx === 0 ? capFirst(p) : capFirst(p);
				}).join("'");
			}
			function formatWord(word, idx){
				if (!word) return '';
				var w = word;
				// Preserve initials like "j." or "j" -> "J." / "J"
				if (/^[a-z]\.?$/.test(w)) return w.toUpperCase();
				// All-caps acronyms of length<=4 remain as-is
				if (/^[A-Z]{2,4}$/.test(w)) return w;
				// Roman numerals -> uppercase
				if (ROMAN_NUMERALS.has(w.toLowerCase())) return w.toUpperCase();
				// Keep particles lower when not the first token
				if (idx > 0 && LOWER_PARTICLES.indexOf(w.toLowerCase()) !== -1) return w.toLowerCase();
				// Handle Mc/Mac prefixes
				if (/^mc[a-z]+/i.test(w)) return 'Mc' + capFirst(w.slice(2));
				if (/^mac[a-z]+/i.test(w)) return 'Mac' + capFirst(w.slice(3));
				// Hyphenated and apostrophized names
				if (w.indexOf('-') !== -1) return capHyphenated(w);
				if (/[’']/.test(w)) return capApostrophe(w);
				return capFirst(w);
			}

			window.formatAuthorName = function(name){
				if (!name || typeof name !== 'string') return '';
				var s = name.trim();
				// If name contains a comma (e.g., "Last, First"), format each side but keep order
				if (s.includes(',')) {
					var parts = s.split(',');
					var left = parts[0].trim();
					var right = parts.slice(1).join(',').trim();
					var leftFmt = left.split(/\s+/).map(function(w,i){ return formatWord(w, i); }).join(' ');
					var rightFmt = right ? right.split(/\s+/).map(function(w,i){ return formatWord(w, i); }).join(' ') : '';
					return rightFmt ? (leftFmt + ', ' + rightFmt) : leftFmt;
				}
				return s.split(/\s+/).map(function(w,i){ return formatWord(w, i); }).join(' ');
			};

			window.formatAuthorsDisplay = function(authorsVal){
				if (Array.isArray(authorsVal)) {
					return authorsVal.map(function(a){ return window.formatAuthorName(String(a||'')); }).filter(Boolean).join(', ');
				}
				if (typeof authorsVal === 'string') {
					var s = authorsVal.trim();
					// Split multi-author strings on " & " or " and " or "|" or ";" but NOT on commas (commas can denote last, first)
					var parts = s.split(/\s+(?:&|and)\s+|[|;]+/i).map(function(p){ return p.trim(); }).filter(Boolean);
					if (parts.length > 1) {
						return parts.map(function(p){ return window.formatAuthorName(p); }).join(', ');
					}
					return window.formatAuthorName(s);
				}
				if (authorsVal && typeof authorsVal === 'object' && authorsVal.name) {
					return window.formatAuthorName(String(authorsVal.name||''));
				}
				return 'Unknown author';
			};
		})();

		// Test function to debug modal with sample request data
		window.testRequestModal = function() {
			var testData = {
				title: "Test Book",
				authors: ["Test Author"],
				requesterEmail: "test@example.com",
				status: "pending",
				requestId: 123,
				isAdmin: true,
				readarrRequest: true
			};
			window.openBookModal(testData, false);
		};
		
		// Open the book modal with a plain data object or parse provider payload
		window.openBookModal = function(data, loading) {
			// Guard against non-object inputs (e.g., accidental numeric "1")
			if (!data || typeof data !== 'object') {
				data = {};
			}
			try {
				var modal = document.getElementById('book-modal');
				var cover = document.getElementById('book-modal-cover');
				var title = document.getElementById('book-modal-title');
				var authors = document.getElementById('book-modal-authors');
				var meta = document.getElementById('book-modal-meta');
				var desc = document.getElementById('book-modal-description');
				
				// Request-specific elements
				var requestInfo = document.getElementById('book-modal-request-info');
				var requester = document.getElementById('book-modal-requester');
				var status = document.getElementById('book-modal-status');
				var actionsSection = document.getElementById('book-modal-actions');
				var userActions = document.getElementById('book-modal-user-actions');
				var reqEbookBtn = document.getElementById('book-modal-request-ebook');
				var reqAudioBtn = document.getElementById('book-modal-request-audiobook');
				var approveBtn = document.getElementById('book-modal-approve');
				var attachBtn = document.getElementById('book-modal-attach');
				var declineBtn = document.getElementById('book-modal-decline');
				var deleteBtn = document.getElementById('book-modal-delete');
				
				if (!modal) {
					return;
				}
				
				// Show loading state if requested
				if (loading) {
					var loadingCover = (data.cover && data.cover.trim()) || (data.coverMedium && data.coverMedium.trim()) || (data.coverSmall && data.coverSmall.trim()) || '/static/placeholder-cover.svg';
					cover.src = loadingCover;
					title.textContent = data.title || data.Title || 'Loading...';
					authors.textContent = 'Loading...';
					meta.textContent = 'Loading metadata...';
					desc.textContent = 'Fetching additional information...';
					
					// Hide request-specific sections during loading
					if (requestInfo) requestInfo.classList.add('hidden');
					if (actionsSection) actionsSection.classList.add('hidden');
					
					modal.classList.remove('hidden');
					modal.setAttribute('aria-hidden', 'false');
					return;
				}
				
				// Check if this is request data (has requesterEmail or requestId)
				var isRequest = data.requesterEmail || data.requestId || data.RequesterEmail;
				
				// Show/hide request-specific sections
				if (requestInfo) {
					if (isRequest) {
						requestInfo.classList.remove('hidden');
						if (requester) requester.textContent = data.requesterEmail || data.RequesterEmail || 'Unknown';
						if (status) {
							var statusText = data.status || data.Status || 'pending';
							var statusColor = statusText === 'queued' ? 'text-green-400' : 
											  statusText === 'pending' ? 'text-yellow-400' :
											  statusText === 'declined' ? 'text-red-400' :
											  statusText === 'processing' ? 'text-blue-400' : 'text-gray-400';
							status.innerHTML = '<span class="' + statusColor + '">' + statusText + '</span>';
						}
					} else {
						requestInfo.classList.add('hidden');
					}
				}
				
				// Show/hide action buttons for requests
				if (actionsSection && isRequest) {
					// Only show actions if user is admin
					var isAdmin = data.isAdmin || false;
					if (isAdmin) {
						actionsSection.classList.remove('hidden');
						var requestStatus = data.status || data.Status || 'pending';
						var hasReadarrReq = !!(data.readarrRequest || data.ReadarrReq);
						var requestId = data.requestId || data.id || data.ID;
						
						// Show appropriate buttons based on status and data
						if (approveBtn) {
							if (requestStatus === 'pending') {
								approveBtn.classList.remove('hidden');
								if (!hasReadarrReq) {
									approveBtn.classList.add('opacity-60', 'cursor-not-allowed');
									approveBtn.disabled = true;
									approveBtn.title = 'Missing selection payload; re-create the request from Search';
								} else {
									approveBtn.classList.remove('opacity-60', 'cursor-not-allowed');
									approveBtn.disabled = false;
									approveBtn.title = '';
								}
								approveBtn.onclick = function() { handleRequestAction('approve', requestId); };
							} else {
								approveBtn.classList.add('hidden');
							}
						}
						
						if (attachBtn) {
							if (requestStatus === 'pending' && !hasReadarrReq) {
								attachBtn.classList.remove('hidden');
								attachBtn.onclick = function() { handleRequestAction('hydrate', requestId); };
								attachBtn.title = 'Attempt to attach a selection payload from Readarr';
							} else {
								attachBtn.classList.add('hidden');
							}
						}
						
						if (declineBtn) {
							if (requestStatus === 'declined' || requestStatus === 'queued') {
								declineBtn.classList.add('hidden');
								declineBtn.onclick = null;
							} else {
								declineBtn.classList.remove('hidden');
								declineBtn.onclick = function() { handleRequestAction('decline', requestId); };
							}
						}
						
						if (deleteBtn) {
							deleteBtn.classList.remove('hidden');
							deleteBtn.onclick = function() { 
								if (confirm('Are you sure you want to permanently delete this request?')) {
									handleRequestAction('delete', requestId); 
								}
							};
						}
						var retryBtn = document.getElementById('book-modal-retry');
						if (retryBtn) {
							if (requestStatus === 'approved' || requestStatus === 'queued') {
								retryBtn.classList.remove('hidden');
								retryBtn.onclick = function() { handleRequestAction('retry', requestId); };
							} else {
								retryBtn.classList.add('hidden');
							}
						}
					} else {
						actionsSection.classList.add('hidden');
					}
				} else if (actionsSection) {
					actionsSection.classList.add('hidden');
				}

				// For search results (not a request), show user request buttons if we have at least a title
				if (userActions) {
					if (!isRequest && (data.title || data.isbn13 || data.isbn10 || data.asin)) {
						userActions.classList.remove('hidden');
						// Attach click handlers that submit requests with the same helper used elsewhere
						if (reqEbookBtn) {
							reqEbookBtn.onclick = function(){
								window.submitRequestFromModal('ebook', data);
							};
						}
						if (reqAudioBtn) {
							reqAudioBtn.onclick = function(){
								window.submitRequestFromModal('audiobook', data);
							};
						}
					} else {
						userActions.classList.add('hidden');
					}
				}
				
				// Populate fields, tolerant of missing keys
				// Try Readarr image fields first, then fallback to original cover fields
				var coverUrl = data.cover || data.remoteCover;
				if (!coverUrl && data.images && data.images.length > 0) {
					// Find cover image from Readarr images array
					var coverImage = data.images.find(function(img) { return img.coverType === 'cover'; });
					if (coverImage) {
						coverUrl = coverImage.remoteUrl || coverImage.url;
					}
				}
				var finalCover = (coverUrl && coverUrl.trim()) || (data.coverMedium && data.coverMedium.trim()) || (data.coverSmall && data.coverSmall.trim()) || '/static/placeholder-cover.svg';
				cover.src = finalCover;
				title.textContent = data.title || data.Title || 'No title';
				// Smart-capitalize author names for display
				var authorsDisplay = 'Unknown author';
				if (data.hasOwnProperty('authors')) {
					authorsDisplay = window.formatAuthorsDisplay(data.authors);
				} else if (typeof data.author === 'string' && data.author.trim() !== '') {
					authorsDisplay = window.formatAuthorsDisplay(data.author);
				}
				authors.textContent = authorsDisplay;
				
				// Data is already enriched from the new API endpoint, no need to extract provider_payload
				var enrichedData = data;
				
				// Build metadata from actual Readarr data
				var metaParts = [];
				if (enrichedData.ratings && enrichedData.ratings.value) {
					var stars = '★'.repeat(Math.floor(enrichedData.ratings.value)) + '☆'.repeat(5 - Math.floor(enrichedData.ratings.value));
					metaParts.push(`Rating: ${enrichedData.ratings.value.toFixed(1)}/5 ${stars} (${enrichedData.ratings.votes} votes)`);
				}
				if (enrichedData.pageCount) metaParts.push(`Pages: ${enrichedData.pageCount}`);
				if (enrichedData.releaseDate) {
					var releaseYear = new Date(enrichedData.releaseDate).getFullYear();
					metaParts.push(`Published: ${releaseYear}`);
				}
				if (enrichedData.seriesTitle) metaParts.push(`Series: ${enrichedData.seriesTitle}`);
				if (data.isbn13) metaParts.push('ISBN-13: ' + data.isbn13);
				if (data.isbn10) metaParts.push('ISBN-10: ' + data.isbn10);
				if (data.asin) metaParts.push('ASIN: ' + data.asin);
				
				meta.textContent = metaParts.join(' • ');
				// Description: try common keys
				var description = data.description || data.overview || data.synopsis || data.summary || data.desc || data.about || '';
				// If provider payload nested description exists, handle it
				if (!description && data.provider_payload) {
					try {
						var pp = typeof data.provider_payload === 'string' ? JSON.parse(data.provider_payload) : data.provider_payload;
						description = pp.description || pp.overview || pp.synopsis || pp.summary || pp.details || '';
						// Some providers embed description under different keys
						if (!description) {
							for (var k in pp) {
								if (typeof pp[k] === 'string' && pp[k].length > 50) { description = pp[k]; break; }
							}
						}
					} catch(e) { /* ignore parse errors */ }
				}
				
				// If no description found, show other useful information
				if (!description) {
					// Build a clean fallback description without a noisy header
					var descParts = [];
					
					// Show genres if available
					if (data.genres && data.genres.length > 0) {
						descParts.push('Genres: ' + data.genres.slice(0, 5).join(', ') + (data.genres.length > 5 ? ', and more...' : ''));
					}
					
					// Show series information if available
					if (data.seriesTitle && data.seriesTitle.trim() !== '') {
						descParts.push('Series: ' + data.seriesTitle);
					}
					
					// Show additional metadata
					if (data.authorTitle && data.authorTitle.trim() !== '') {
						var authorParts = data.authorTitle.split(' ');
						if (authorParts.length > 2) {
							// Skip if it's just author + title repetition
							var cleanAuthor = authorParts.slice(0, -data.title.split(' ').length).join(' ');
							if (cleanAuthor.length > 0) descParts.push('Full Author: ' + cleanAuthor);
						}
					}
					
					// Show Goodreads links if available
					if (data.links && data.links.length > 0) {
						var goodreadsLinks = data.links.filter(function(link) { return link.name && link.name.includes('Goodreads'); });
						if (goodreadsLinks.length > 0) {
							var linkHtml = 'View on Goodreads for full description and reviews:<br>';
							goodreadsLinks.forEach(function(link) {
								linkHtml += '• <a href="' + link.url + '" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">' + link.name + '</a><br>';
							});
							descParts.push(linkHtml);
						}
					}
					
					description = descParts.join('<br><br>');
				}
				
				// Use innerHTML if we have HTML links, otherwise textContent
				if (description && description.includes('<a href=')) {
					desc.innerHTML = description || 'No description available.';
				} else {
					desc.textContent = description || 'No description available.';
				}
				// Show modal
				modal.classList.remove('hidden');
				modal.setAttribute('aria-hidden', 'false');
				// focus close button for accessibility
				setTimeout(function(){ var cb = document.getElementById('book-modal-close'); if(cb) cb.focus(); }, 50);
			} catch(e) { /* ignore modal errors */ }
		}

		window.closeBookModal = function() {
			var modal = document.getElementById('book-modal'); if(!modal) return;
			modal.classList.add('hidden');
			modal.setAttribute('aria-hidden', 'true');
		}

		// Submit a request from the modal (used for search result popups)
		window.submitRequestFromModal = async function(format, data){
			try{
				var btnE = document.getElementById('book-modal-request-ebook');
				var btnA = document.getElementById('book-modal-request-audiobook');
				var btnTarget = (format === 'audiobook') ? btnA : btnE;
				if (btnTarget) btnTarget.classList.add('opacity-60','pointer-events-none');

				var payload = {
					title: (data.title||'').toString(),
					authors: Array.isArray(data.authors) ? data.authors : (data.author ? [data.author] : []),
					isbn10: (data.isbn10||'').toString(),
					isbn13: (data.isbn13||'').toString(),
					asin: (data.asin||'').toString(),
					format: (format||'ebook'),
					provider: (data.provider||'').toString()
				};
				// Include correct provider payload if available
				if ((format||'ebook') === 'ebook' && data.provider_payload_ebook) {
					payload.provider_payload = data.provider_payload_ebook;
				} else if ((format||'ebook') === 'audiobook' && data.provider_payload_audiobook) {
					payload.provider_payload = data.provider_payload_audiobook;
				} else if (data.provider_payload) {
					payload.provider_payload = data.provider_payload;
				}

				var resp = await fetch('/api/v1/requests', {
					method: 'POST',
					body: JSON.stringify(payload),
					headers: { 'HX-Request':'true', 'Content-Type':'application/json' },
					credentials: 'same-origin'
				});

				if (resp.ok) {
					// Mark only the clicked button as requested; leave the other available
					if (btnTarget) {
						btnTarget.textContent = 'Requested ✓';
						btnTarget.classList.add('bg-emerald-600');
						btnTarget.classList.remove('bg-royal-600','hover:bg-royal-700','hover:bg-royal-600','hover:bg-royal-500','opacity-60','pointer-events-none');
						btnTarget.disabled = true;
					}
					scriptorumShowToast('Request submitted. Open Requests to view.');
					// Also reflect the selection on the main search list (if visible)
					try {
						var matchForm = null;
						var title = (data.title||'').trim();
						var isbn13 = (data.isbn13||'').trim();
						var isbn10 = (data.isbn10||'').trim();
						var asin = (data.asin||'').trim();
						document.querySelectorAll('form[data-isbn13], form[data-isbn10], form[data-asin], form[data-title]').forEach(function(f){
							if (matchForm) return;
							var fIsbn13 = (f.dataset.isbn13||'').trim();
							var fIsbn10 = (f.dataset.isbn10||'').trim();
							var fAsin = (f.dataset.asin||'').trim();
							var fTitle = (f.dataset.title||'').trim();
							if (isbn13 && fIsbn13 && isbn13 === fIsbn13) { matchForm = f; return; }
							if (!matchForm && isbn10 && fIsbn10 && isbn10 === fIsbn10) { matchForm = f; return; }
							if (!matchForm && asin && fAsin && asin === fAsin) { matchForm = f; return; }
							if (!matchForm && title && fTitle && title === fTitle) { matchForm = f; return; }
						});
						if (matchForm) {
							var sel = (format === 'audiobook') ? 'button[name="format"][value="audiobook"]' : 'button[name="format"][value="ebook"]';
							var listBtn = matchForm.querySelector(sel);
							if (listBtn) {
								listBtn.textContent = 'Requested ✓';
								listBtn.classList.add('bg-emerald-600');
								listBtn.classList.remove('bg-royal-600','hover:bg-royal-700','hover:bg-royal-600','hover:bg-royal-500','opacity-60','pointer-events-none');
								listBtn.disabled = true;
							}
						}
					} catch(e) { /* ignore sync errors */ }
					// Optionally refresh requests table if present
					var reqTable = document.querySelector('#req-table');
					if (reqTable && window.htmx) { htmx.trigger(reqTable, 'refresh'); }
				} else if (resp.status === 302 || resp.redirected) {
					scriptorumShowToast('Not signed in. Please log in.', 'bg-amber-50 text-amber-800 ring-1 ring-amber-200');
					if (btnTarget) btnTarget.classList.remove('opacity-60','pointer-events-none');
				} else {
					var txt = await resp.text();
					scriptorumShowToast('Error: ' + (txt||resp.status), 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
					if (btnTarget) btnTarget.classList.remove('opacity-60','pointer-events-none');
				}
			}catch(err){
				scriptorumShowToast('Network error submitting request', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
				var btnE = document.getElementById('book-modal-request-ebook');
				var btnA = document.getElementById('book-modal-request-audiobook');
				var btnTarget = (format === 'audiobook') ? btnA : btnE;
				if (btnTarget) btnTarget.classList.remove('opacity-60','pointer-events-none');
			}
		}

		// Handle request actions (approve, decline, delete, hydrate)
		window.handleRequestAction = function(action, requestId) {
			if (!requestId) {
				return;
			}
			
			var apiUrl;
			var method = 'POST';
			
			switch (action) {
				case 'approve':
					apiUrl = '/api/v1/requests/' + requestId + '/approve';
					break;
				case 'retry':
					apiUrl = '/api/v1/requests/' + requestId + '/retry';
					break;
				case 'decline':
					apiUrl = '/api/v1/requests/' + requestId + '/decline';
					break;
				case 'delete':
					apiUrl = '/api/v1/requests/' + requestId;
					method = 'DELETE';
					break;
				case 'hydrate':
					apiUrl = '/api/v1/requests/' + requestId + '/hydrate';
					break;
				default:
					return;
			}
			
			// Make the API call
			fetch(apiUrl, {
				method: method,
				headers: {
					'Content-Type': 'application/json',
					'HX-Request': 'true'
				},
				credentials: 'same-origin'
			})
			.then(function(resp) {
				if (resp.ok) {
					// Close modal
					window.closeBookModal();
					// Refresh requests table if it exists
					var reqTable = document.querySelector('#req-table');
					if (reqTable && window.htmx) {
						htmx.trigger(reqTable, 'refresh');
					}
					// Show success message
					var actionText = action === 'delete' ? 'deleted' : 
									action === 'approve' ? 'approved' : 
									action === 'decline' ? 'declined' :
									action === 'hydrate' ? 'updated' : action + 'd';
					window.scriptorumShowToast && window.scriptorumShowToast('Request ' + actionText + ' successfully.');
				} else {
					resp.text().then(function(text) {
						var errorMsg = text || 'Action failed: ' + resp.status;
						window.scriptorumShowToast && window.scriptorumShowToast('Error: ' + errorMsg, 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
					});
				}
			})
			.catch(function(err) {
				window.scriptorumShowToast && window.scriptorumShowToast('Network error occurred.', 'bg-rose-50 text-rose-800 ring-1 ring-rose-200');
			});
		}

		// Helper: open modal from an element inside the search result item (li)
		window.openBookModalFromElem = function(el){
			try {
				var li = el.closest('li');
				if (!li) {
					return;
				}
				var form = li.querySelector('form');
				if (!form) {
					return;
				}
				var data = {};
				if (form) {
					var ds = form.dataset || {};
					data.title = ds.title || form.querySelector('input[name="title"]')?.value || '';
					data.isbn10 = ds.isbn10 || form.querySelector('input[name="isbn10"]')?.value || '';
					data.isbn13 = ds.isbn13 || form.querySelector('input[name="isbn13"]')?.value || '';
					data.asin = ds.asin || form.querySelector('input[name="asin"]')?.value || '';
					// authors: collect all hidden inputs
					var authEls = form.querySelectorAll('input[name="authors"]');
					if (authEls && authEls.length) { data.authors = Array.from(authEls).map(i=>i.value); }
					// pick provider payload if present
					var pIn = form.querySelector('input[name="provider_payload"]');
					var ppe = form.querySelector('input[name="provider_payload_ebook"]');
					var ppa = form.querySelector('input[name="provider_payload_audiobook"]');
					if (ppe && ppe.value) data.provider_payload_ebook = ppe.value;
					if (ppa && ppa.value) data.provider_payload_audiobook = ppa.value;
					if (pIn && pIn.value) data.provider_payload = pIn.value;
					// keep provider label if available
					var prov = form.querySelector('input[name="provider"]');
					if (prov && prov.value) data.provider = prov.value;
				}
				// also gather cover src if available in li
				var img = li.querySelector('img'); if (img && img.src) data.cover = img.src;
				
				// Check if we have enough information for a good modal display
				var hasDescription = false;
				if (data.provider_payload) {
					try {
						var pp = typeof data.provider_payload === 'string' ? JSON.parse(data.provider_payload) : data.provider_payload;
						hasDescription = !!(pp.description || pp.overview || pp.synopsis || pp.summary || pp.details);
					} catch(e) { /* ignore parse errors */ }
				}
				
				// If we don't have a description, try to fetch enriched data from API
				if (!hasDescription && (data.provider_payload || data.isbn13 || data.isbn10 || data.asin)) {
					// Show modal immediately with loading state
					window.openBookModal(data, true);
					
					// Prepare payload for enriched API - send basic identifiers
					var apiPayload = {
						title: data.title,
						authors: data.authors
					};
					if (data.isbn13) apiPayload.isbn13 = data.isbn13;
					if (data.isbn10) apiPayload.isbn10 = data.isbn10;  
					if (data.asin) apiPayload.asin = data.asin;
					
					fetch('/api/v1/book/enriched', {
						method: 'POST',
						headers: { 
							'Content-Type': 'application/json',
							'HX-Request': 'true'
						},
						body: JSON.stringify(apiPayload),
						credentials: 'same-origin'
					})
					.then(function(resp) {
						if (!resp.ok) {
							window.openBookModal(data);
							return;
						}
						return resp.json();
					})
					.then(function(enrichedData) {
						if (enrichedData && !enrichedData.error) {
							// Use enriched data directly - it contains all the Readarr fields
							// Add original cover URL if not present in enriched data
							if (!enrichedData.cover && data.cover) {
								enrichedData.cover = data.cover;
							}
							window.openBookModal(enrichedData);
						} else {
							window.openBookModal(data);
						}
					})
					.catch(function(err) {
						window.openBookModal(data);
					});
				} else {
					// We have sufficient data or no way to fetch more, show modal directly
					window.openBookModal(data);
				}
			} catch(e) { /* ignore errors */ }
		}

		// Close handlers
		document.addEventListener('click', function(e){
			var modal = document.getElementById('book-modal'); if(!modal) return;
			var backdrop = document.getElementById('book-modal-backdrop');
			if (backdrop && (e.target === backdrop)) { window.closeBookModal(); }
			if (e.target && e.target.id === 'book-modal-close') { window.closeBookModal(); }
		});
		document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ window.closeBookModal(); } });

		// Generic HTMX form state handler (no inline hx-on needed)
		document.body.addEventListener('htmx:beforeRequest', function(evt){
			try {
				var form = evt.target;
				if (!form || !form.classList || !form.classList.contains('js-approve-form')) return;
				var btn = form.querySelector('button');
				if (!btn) return;
				btn.classList.add('opacity-50');
				var working = btn.getAttribute('data-label-working') || 'Working...';
				btn.textContent = working;
			} catch {}
		});
		document.body.addEventListener('htmx:afterRequest', function(evt){
			try {
				var form = evt.target;
				if (!form || !form.classList || !form.classList.contains('js-approve-form')) return;
				var btn = form.querySelector('button');
				if (!btn) return;
				btn.classList.remove('opacity-50');
				var def = btn.getAttribute('data-label-default') || 'Submit';
				btn.textContent = def;
			} catch {}
		});
		document.body.addEventListener('htmx:responseError', function(evt){
			try {
				var form = evt.target;
				if (!form || !form.classList || !form.classList.contains('js-approve-form')) return;
				var btn = form.querySelector('button');
				if (!btn) return;
				btn.classList.add('bg-rose-600');
				btn.textContent = 'Approve failed';
				setTimeout(function(){ btn.textContent = btn.getAttribute('data-label-default') || 'Submit'; btn.classList.remove('bg-rose-600','opacity-50'); }, 2200);
			} catch {}
		});

		// Centralized notifications for simple HTMX buttons (no inline hx-on)
		document.body.addEventListener('htmx:beforeRequest', function(evt){
			try {
				var el = evt.target;
				if (!el || !el.classList || !el.classList.contains('js-notify-on-htmx')) return;
				var btn = el;
				if (!btn.getAttribute('data-label-default')) {
					btn.setAttribute('data-label-default', (btn.textContent || '').trim());
				}
				var working = btn.getAttribute('data-label-working') || 'Working...';
				btn.disabled = true;
				btn.classList.add('opacity-50','cursor-not-allowed');
				btn.textContent = working;
			} catch {}
		});
		document.body.addEventListener('htmx:afterRequest', function(evt){
			try {
				var el = evt.target;
				if (!el || !el.classList || !el.classList.contains('js-notify-on-htmx')) return;
				var btn = el;
				var ok = false;
				if (evt.detail && typeof evt.detail.successful === 'boolean') { ok = evt.detail.successful; }
				else if (evt.detail && evt.detail.xhr) { ok = evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300; }
				var msg = ok ? (btn.getAttribute('data-success-message') || 'Done.') : (btn.getAttribute('data-failure-message') || 'Request failed.');
				try { alert(msg); } catch {}
				btn.disabled = false;
				btn.classList.remove('opacity-50','cursor-not-allowed');
				btn.textContent = btn.getAttribute('data-label-default') || 'Submit';
			} catch {}
		});
		document.body.addEventListener('htmx:responseError', function(evt){
			try {
				var el = evt.target;
				if (!el || !el.classList || !el.classList.contains('js-notify-on-htmx')) return;
				var btn = el;
				var msg = btn.getAttribute('data-failure-message') || 'Request failed.';
				try { alert(msg); } catch {}
				btn.disabled = false;
				btn.classList.remove('opacity-50','cursor-not-allowed');
				btn.textContent = btn.getAttribute('data-label-default') || 'Submit';
			} catch {}
		});

		// Reset search pagination to 1 whenever the query input changes (replaces inline hx-on)
		document.addEventListener('input', function(evt){
			var t = evt.target;
			if (!t || t.name !== 'q') return;
			var form = t.closest && t.closest('#searchForm');
			if (!form) return;
			var pageInput = form.querySelector('input[name=page]');
			if (pageInput) { pageInput.value = '1'; }
		});

		// Delegate clicks/key presses for opening book details on elements with data-open-book
		document.addEventListener('click', function(e){
			try {
				var t = e.target;
				// ignore if click is directly on interactive elements or their immediate children
				if (t.tagName === 'BUTTON' || t.tagName === 'A' || t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.tagName === 'SELECT') return;
				// ignore if click is inside a form but allow clicks on the book data area
				if (t.closest && t.closest('button, a, input, textarea, select')) return;
				var el = t.closest && t.closest('[data-open-book]');
				if (el) {
					// Check if this element has JSON data directly (requests table). Search results set a sentinel like "1".
					var jsonData = el.getAttribute('data-open-book');
					if (jsonData) {
						var isJsonLike = /^\s*[{\[]/.test(jsonData);
						if (!isJsonLike) {
							// Not a JSON payload (likely "1"), use form extraction path
							openBookModalFromElem(el);
							return;
						}
						try {
							var bookData = JSON.parse(jsonData);
							if (!bookData || typeof bookData !== 'object') {
								openBookModalFromElem(el);
								return;
							}
							// For requests table, call enriched API to get full details
							if (bookData.title || bookData.isbn13 || bookData.isbn10 || bookData.asin) {
								// Show modal with loading state first
								window.openBookModal(bookData, true);
								// Make API call for enriched data
								fetch('/api/v1/book/enriched', {
									method: 'POST',
									headers: { 'Content-Type': 'application/json', 'HX-Request': 'true' },
									body: JSON.stringify(bookData),
									credentials: 'same-origin'
								})
								.then(function(resp) { if (!resp.ok) { window.openBookModal(bookData); return; } return resp.json(); })
								.then(function(enrichedData) {
									if (enrichedData && !enrichedData.error) {
										var mergedData = Object.assign({}, enrichedData);
										if (bookData.requesterEmail) mergedData.requesterEmail = bookData.requesterEmail;
										if (bookData.status) mergedData.status = bookData.status;
										if (bookData.requestId) mergedData.requestId = bookData.requestId;
										if (bookData.hasOwnProperty('isAdmin')) mergedData.isAdmin = bookData.isAdmin;
										if (bookData.readarrRequest) mergedData.readarrRequest = bookData.readarrRequest;
										window.openBookModal(mergedData);
									} else {
										window.openBookModal(bookData);
									}
								})
								.catch(function(err) { window.openBookModal(bookData); });
							} else {
								// No identifiers, just open with basic data
								window.openBookModal(bookData);
							}
							return;
						} catch(parseError) {
							openBookModalFromElem(el);
							return;
						}
					}
					// Fallback to form extraction for search results
					openBookModalFromElem(el);
				}
			} catch(err) { }
		});
		document.addEventListener('keydown', function(e){
			if (e.key === 'Enter') {
				var active = document.activeElement;
				if (active && active.getAttribute && active.getAttribute('data-open-book') !== null) {
					// Check if this element has JSON data directly (requests table)
					var jsonData = active.getAttribute('data-open-book');
					if (jsonData) {
						var isJsonLike = /^\s*[{\[]/.test(jsonData);
						if (!isJsonLike) {
							openBookModalFromElem(active);
							e.preventDefault();
							return;
						}
						try {
							var bookData = JSON.parse(jsonData);
							if (!bookData || typeof bookData !== 'object') { openBookModalFromElem(active); e.preventDefault(); return; }
							// For requests table, call enriched API to get full details
							if (bookData.title || bookData.isbn13 || bookData.isbn10 || bookData.asin) {
								// Show modal with loading state first
								window.openBookModal(bookData, true);
								// Make API call for enriched data
								fetch('/api/v1/book/enriched', {
									method: 'POST',
									headers: { 'Content-Type': 'application/json', 'HX-Request': 'true' },
									body: JSON.stringify(bookData),
									credentials: 'same-origin'
								})
								.then(function(resp) { if (!resp.ok) { window.openBookModal(bookData); return; } return resp.json(); })
								.then(function(enrichedData) {
									if (enrichedData && !enrichedData.error) {
										var mergedData = Object.assign({}, enrichedData);
										if (bookData.requesterEmail) mergedData.requesterEmail = bookData.requesterEmail;
										if (bookData.status) mergedData.status = bookData.status;
										if (bookData.requestId) mergedData.requestId = bookData.requestId;
										if (bookData.hasOwnProperty('isAdmin')) mergedData.isAdmin = bookData.isAdmin;
										if (bookData.readarrRequest) mergedData.readarrRequest = bookData.readarrRequest;
										window.openBookModal(mergedData);
									} else {
										window.openBookModal(bookData);
									}
								})
								.catch(function(err) { window.openBookModal(bookData); });
							} else {
								// No identifiers, just open with basic data
								window.openBookModal(bookData);
							}
							e.preventDefault();
							return;
						} catch(parseError) {
							openBookModalFromElem(active);
							e.preventDefault();
							return;
						}
					}
					
					// Fallback to form extraction for search results
					openBookModalFromElem(active);
					e.preventDefault();
				}
			}
		});
	</script>

	</main>
	</body>
	</html>
{{ end }}