<div class="bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10">

  <div class="p-4 border-b border-white/5">
    <h2 class="font-semibold">Results for “{{ .Query }}”</h2>
  </div>
  <ul class="divide-y divide-white/5">
    {{ range .Items }}
  <li class="p-4 grid gap-6 items-start grid-cols-[auto,1fr] md:grid-cols-[auto,1fr,24rem]">
      <!-- Use placeholder if no cover; fallback on error -->
      <img src="{{ if .CoverMedium }}{{ .CoverMedium }}{{ else }}/static/placeholder-cover.svg{{ end }}"
           class="w-16 h-24 object-cover rounded-lg border border-white/10 bg-night-900"
           onerror="this.onerror=null; this.src='/static/placeholder-cover.svg';">

      <div class="min-w-0 pl-2 md:pl-0">
        <div class="font-medium truncate">{{ .Title }}</div>
        <div class="text-sm text-slate-400 whitespace-normal break-words">
          {{ if gt (len .Authors) 0 }}
            {{ if eq (len .Authors) 1 }}
              {{ index .Authors 0 }}
            {{ else }}
              {{ range $i, $author := .Authors }}{{ if $i }}, {{ end }}{{ $author }}{{ end }}
            {{ end }}
          {{ else }}
            Unknown Author
          {{ end }}
        </div>
        <div class="text-xs text-slate-400">
          {{ if .ISBN13 }}ISBN-13: {{ .ISBN13 }}{{ end }}
          {{ if and .ISBN13 .ISBN10 }}, {{ end }}
          {{ if .ISBN10 }}ISBN-10: {{ .ISBN10 }}{{ end }}
          {{ if .ASIN }}{{ if or .ISBN13 .ISBN10 }}, {{ end }}ASIN: {{ .ASIN }}{{ end }}
        </div>
        <!-- Source label removed: do not display which instance returned the result -->
      </div>

  <form method="post" action="/api/v1/requests" class="col-span-2 md:col-span-1 md:col-start-3 flex flex-wrap gap-2 items-center justify-start md:justify-end mt-2 md:mt-0"
            data-title="{{ .Title }}"
            data-isbn10="{{ .ISBN10 }}"
            data-isbn13="{{ .ISBN13 }}"
            data-asin="{{ .ASIN }}"
            data-author="{{ if gt (len .Authors) 0 }}{{ index .Authors 0 }}{{ end }}"
            hx-on:htmx:after-request="
              if (event.detail.successful) {
                const btns = this.querySelectorAll('button');
                btns.forEach(btn => {
                  btn.textContent = 'Requested ✓';
                  btn.classList.remove('bg-royal-600', 'bg-royal-500', 'hover:bg-royal-700', 'hover:bg-royal-600');
                  btn.classList.add('bg-emerald-600');
                  btn.disabled = true;
                });
              }
            ">
        <input type="hidden" name="title" value="{{ .Title }}">
        {{ range .Authors }}
        <input type="hidden" name="authors" value="{{ . }}">
        {{ end }}
        <input type="hidden" name="isbn10" value="{{ .ISBN10 }}">
        <input type="hidden" name="isbn13" value="{{ .ISBN13 }}">
        <input type="hidden" name="asin" value="{{ .ASIN }}">
        <!-- Always include provider payloads so server can attach Readarr payloads without exposing source -->
        <input type="hidden" name="provider_payload" value='{{ .ProviderPayload }}'>
        <input type="hidden" name="provider_payload_ebook" value='{{ .ProviderEbookPayload }}'>
        <input type="hidden" name="provider_payload_audiobook" value='{{ .ProviderAudiobookPayload }}'>

        <!-- Use the same purple and fixed width for both buttons so layout doesn't shift -->
        <button type="button" name="format" value="ebook"
                class="px-3 py-2 rounded-lg bg-royal-600 text-white hover:bg-royal-500 w-full sm:w-44"
                hx-post="/api/v1/requests"
                hx-trigger="click"
                hx-vals="js:buildRequestPayload(this, 'ebook')"
                hx-headers='{"Content-Type": "application/json"}'
                hx-indicator="closest li .req-ind"
                hx-on::after-request="handleRequestResponse(event, this, 'ebook')"
                onclick="if(!window.htmx) scriptorumRequestFallback(this,'ebook')">
          Request eBook
        </button>
        <button type="button" name="format" value="audiobook"
                class="px-3 py-2 rounded-lg bg-royal-600 text-white hover:bg-royal-500 w-full sm:w-44"
                hx-post="/api/v1/requests"
                hx-trigger="click"
                hx-vals="js:buildRequestPayload(this, 'audiobook')"
                hx-headers='{"Content-Type": "application/json"}'
                hx-indicator="closest li .req-ind"
                hx-on::after-request="handleRequestResponse(event, this, 'audiobook')"
                onclick="if(!window.htmx) scriptorumRequestFallback(this,'audiobook')">
          Request Audiobook
        </button>
      </form>

      <div class="req-ind htmx-indicator text-xs text-slate-400 hidden md:col-start-3">Submitting…</div>
    </li>
    {{ else }}
    <li class="p-6 text-slate-400">No results.</li>
    {{ end }}
  </ul>
</div>
