{{ template "header" . }}
<div class="bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10 p-5">
	<h1 class="text-xl font-semibold mb-4">Notifications</h1>
	<form method="post" action="/notifications/save" class="grid gap-6">
		<input type="hidden" name="_csrf_token" value="{{.CSRFToken}}">
		
		<!-- Notification Provider Selection -->
		<div class="border border-white/20 rounded-lg bg-night-750 p-5">
			<section class="mb-6">
				<h2 class="font-semibold mb-2">Notification Provider</h2>
				<div class="border border-white/10 rounded p-3">
					<label class="block text-sm font-medium text-slate-200 mb-2">Select Provider</label>
					<select id="notification_provider" name="notification_provider" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" onchange="toggleNotificationSettings()">
						<option value="">Disabled</option>
						<option value="ntfy" {{ if eq .Notifications.Provider "ntfy" }}selected{{ end }}>ntfy.sh</option>
					</select>
					<div class="text-sm text-slate-400 mt-1">Choose a notification service to receive alerts for book requests and system events.</div>
				</div>
			</section>

			<!-- ntfy.sh Configuration -->
			<section id="ntfy_settings" class="mb-6"{{ if ne .Notifications.Provider "ntfy" }} style="display: none;"{{ end }}>
				<h2 class="font-semibold mb-2">ntfy.sh Configuration</h2>
				<div class="border border-white/10 rounded p-3">
					<div class="grid md:grid-cols-2 gap-3">
						<div>
							<label class="block text-sm font-medium text-slate-200 mb-1">Server URL</label>
							<input name="ntfy_server" placeholder="https://ntfy.sh" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Server }}">
							<div class="text-xs text-slate-400 mt-1">Use https://ntfy.sh or your own ntfy server</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-slate-200 mb-1">Topic</label>
							<input name="ntfy_topic" placeholder="scriptorum-notifications" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Topic }}">
							<div class="text-xs text-slate-400 mt-1">Unique topic name for your notifications</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-slate-200 mb-1">Username (Optional)</label>
							<input name="ntfy_username" placeholder="username" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Username }}">
							<div class="text-xs text-slate-400 mt-1">For protected topics</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-slate-200 mb-1">Password (Optional)</label>
							<input type="password" name="ntfy_password" placeholder="password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Password }}">
							<div class="text-xs text-slate-400 mt-1">For protected topics</div>
						</div>
					</div>
					<div class="mt-3">
						<label class="inline-flex items-center gap-2">
							<input type="checkbox" name="ntfy_enable_request_notifications" {{ if .Notifications.Ntfy.EnableRequestNotifications }}checked{{ end }}> 
							Send notifications for new requests
						</label>
					</div>
					<div class="mt-2">
						<label class="inline-flex items-center gap-2">
							<input type="checkbox" name="ntfy_enable_approval_notifications" {{ if .Notifications.Ntfy.EnableApprovalNotifications }}checked{{ end }}> 
							Send notifications for request approvals
						</label>
					</div>
					<div class="mt-2">
						<label class="inline-flex items-center gap-2">
							<input type="checkbox" name="ntfy_enable_system_notifications" {{ if .Notifications.Ntfy.EnableSystemNotifications }}checked{{ end }}> 
							Send notifications for system events
						</label>
					</div>
					<div class="mt-4 flex items-center gap-2">
						<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testNtfy()">Test Notification</button>
						<span id="ntfy_test" class="text-sm text-slate-400">—</span>
					</div>
				</div>
			</section>

			<!-- Save Button -->
			<div class="flex justify-end">
				<button class="px-4 py-2 rounded-lg bg-royal-600 text-white hover:bg-royal-500">Save</button>
			</div>
		</div>
	</form>
</div>

<script>
function toggleNotificationSettings() {
	const provider = document.getElementById('notification_provider').value;
	const ntfySettings = document.getElementById('ntfy_settings');
	
	if (provider === 'ntfy') {
		ntfySettings.style.display = 'block';
	} else {
		ntfySettings.style.display = 'none';
	}
}

function testNtfy() {
	const testSpan = document.getElementById('ntfy_test');
	const button = document.querySelector('button[onclick="testNtfy()"]');
	
	// Disable button and show loading state
	testSpan.textContent = 'Sending test...';
	testSpan.className = 'text-sm text-blue-400';
	button.disabled = true;
	button.classList.add('opacity-50', 'cursor-not-allowed');
	
	const form = document.querySelector('form');
	const formData = new FormData(form);
	
	// Build test request
	const testData = {
		server: formData.get('ntfy_server') || 'https://ntfy.sh',
		topic: formData.get('ntfy_topic') || 'test',
		username: formData.get('ntfy_username') || '',
		password: formData.get('ntfy_password') || ''
	};

	// Create abort controller for timeout
	const controller = new AbortController();
	const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
	
	fetch('/api/notifications/test-ntfy', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-Requested-With': 'XMLHttpRequest',
			'X-CSRF-Token': formData.get('_csrf_token')
		},
		body: JSON.stringify(testData),
		signal: controller.signal
	})
	.then(response => {
		clearTimeout(timeoutId);
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}`);
		}
		return response.json();
	})
	.then(data => {
		if (data.success) {
			testSpan.textContent = '✓ Test notification sent successfully!';
			testSpan.className = 'text-sm text-emerald-400';
		} else {
			testSpan.textContent = '✗ ' + (data.error || 'Test failed');
			testSpan.className = 'text-sm text-red-400';
		}
	})
	.catch(error => {
		clearTimeout(timeoutId);
		if (error.name === 'AbortError') {
			testSpan.textContent = '✗ Test timed out after 8 seconds';
		} else {
			testSpan.textContent = '✗ ' + (error.message || 'Network error');
		}
		testSpan.className = 'text-sm text-red-400';
	})
	.finally(() => {
		// Re-enable button and remove loading state
		button.disabled = false;
		button.classList.remove('opacity-50', 'cursor-not-allowed');
		
		// Reset status after 5 seconds
		setTimeout(() => {
			testSpan.textContent = '—';
			testSpan.className = 'text-sm text-slate-400';
		}, 5000);
	});
}
</script>

{{ template "footer" . }}