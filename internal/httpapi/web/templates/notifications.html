{{ template "header" . }}
<div class="bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10 p-5">
	<h1 class="text-xl font-semibold mb-4">Notifications</h1>
	<form method="post" action="/notifications/save" class="grid gap-6">
		<input type="hidden" name="_csrf_token" value="{{.CSRFToken}}">
		
		<!-- Notification Provider Selection -->
		<div class="border border-white/20 rounded-lg bg-night-750 p-5">
			<section class="mb-6">
				<h2 class="font-semibold mb-2">Notification Providers</h2>
				<div class="text-sm text-slate-400 mb-4">Enable multiple notification providers to receive alerts for book requests and system events.</div>
				
				<!-- Provider selector (chips only) -->

				<!-- Provider chips -->
				<div class="flex flex-wrap items-center gap-2 mb-2">
					<button type="button" data-provider="ntfy" class="provider-chip inline-flex items-center gap-2 px-3 py-1 rounded-full bg-night-800 hover:bg-night-700 border border-white/10 text-slate-200">
						<span class="w-2 h-2 rounded-full {{ if .Notifications.Ntfy.Enabled }}bg-emerald-500{{ else }}bg-slate-500{{ end }}"></span>
						<span class="text-sm">ntfy.sh</span>
					</button>
					<button type="button" data-provider="smtp" class="provider-chip inline-flex items-center gap-2 px-3 py-1 rounded-full bg-night-800 hover:bg-night-700 border border-white/10 text-slate-200">
						<span class="w-2 h-2 rounded-full {{ if .Notifications.SMTP.Enabled }}bg-emerald-500{{ else }}bg-slate-500{{ end }}"></span>
						<span class="text-sm">SMTP</span>
					</button>
					<button type="button" data-provider="discord" class="provider-chip inline-flex items-center gap-2 px-3 py-1 rounded-full bg-night-800 hover:bg-night-700 border border-white/10 text-slate-200">
						<span class="w-2 h-2 rounded-full {{ if .Notifications.Discord.Enabled }}bg-emerald-500{{ else }}bg-slate-500{{ end }}"></span>
						<span class="text-sm">Discord</span>
					</button>
				</div>

				<!-- Empty state -->
				<div id="empty_state" class="border border-dashed border-white/10 rounded p-6 text-center text-slate-400">
					<div class="text-slate-300 font-medium mb-1">No provider selected</div>
					<div class="text-sm">Choose a provider to configure its settings.</div>
				</div>
				
				<!-- Provider Configuration Sections -->
				<div id="provider_sections" class="space-y-6">
					
					<!-- ntfy.sh Provider -->
					<div id="ntfy_section" class="provider-section border border-white/10 rounded p-4 hidden">
						<div class="flex items-center gap-3 mb-3">
							<input type="checkbox" id="ntfy_enabled" name="ntfy_enabled" value="on" {{ if .Notifications.Ntfy.Enabled }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
							<label for="ntfy_enabled" class="font-medium text-slate-200">Enable ntfy.sh notifications</label>
						</div>
						<div class="grid md:grid-cols-2 gap-3">
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Server URL</label>
								<input name="ntfy_server" placeholder="https://ntfy.sh" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Server }}">
								<div class="text-xs text-slate-400 mt-1">Use https://ntfy.sh or your own ntfy server</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Topic</label>
								<input name="ntfy_topic" placeholder="scriptorum-notifications" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Topic }}">
								<div class="text-xs text-slate-400 mt-1">Unique topic name for your notifications</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Username (Optional)</label>
								<input name="ntfy_username" placeholder="username" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Username }}">
								<div class="text-xs text-slate-400 mt-1">For protected topics</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Password (Optional)</label>
								<input type="password" name="ntfy_password" placeholder="password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Ntfy.Password }}">
								<div class="text-xs text-slate-400 mt-1">For protected topics</div>
							</div>
						</div>
						<div class="mt-3">
							<label class="inline-flex items-center gap-2">
								<input type="checkbox" name="ntfy_enable_request_notifications" value="on" {{ if .Notifications.Ntfy.EnableRequestNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">New request notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="ntfy_enable_approval_notifications" value="on" {{ if .Notifications.Ntfy.EnableApprovalNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">Approval notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="ntfy_enable_system_notifications" value="on" {{ if .Notifications.Ntfy.EnableSystemNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">System notifications</span>
							</label>
						</div>
						<div class="mt-4 flex items-center gap-2">
							<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testNtfy()">Test Notification</button>
							<span id="ntfy_test" class="text-sm text-slate-400">—</span>
						</div>
					</div>

					<!-- SMTP Provider -->
					<div id="smtp_section" class="provider-section border border-white/10 rounded p-4 hidden">
						<div class="flex items-center gap-3 mb-3">
							<input type="checkbox" id="smtp_enabled" name="smtp_enabled" value="on" {{ if .Notifications.SMTP.Enabled }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
							<label for="smtp_enabled" class="font-medium text-slate-200">Enable SMTP email notifications</label>
						</div>
						<div class="grid md:grid-cols-2 gap-3">
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">SMTP Host</label>
								<input name="smtp_host" placeholder="smtp.gmail.com" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.Host }}">
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">SMTP Port</label>
								<input name="smtp_port" type="number" placeholder="587" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.Port }}">
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Username</label>
								<input name="smtp_username" placeholder="your-email@gmail.com" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.Username }}">
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Password</label>
								<input type="password" name="smtp_password" placeholder="your-app-password" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.Password }}">
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">From Email</label>
								<input name="smtp_from_email" placeholder="noreply@yourdomain.com" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.FromEmail }}">
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">From Name</label>
								<input name="smtp_from_name" placeholder="Scriptorum" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.FromName }}">
							</div>
							<div class="md:col-span-2">
								<label class="block text-sm font-medium text-slate-200 mb-1">To Email</label>
								<input name="smtp_to_email" placeholder="admin@yourdomain.com" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.SMTP.ToEmail }}">
							</div>
						</div>
						<div class="mt-3">
							<label class="inline-flex items-center gap-2">
								<input type="checkbox" name="smtp_enable_tls" value="on" {{ if .Notifications.SMTP.EnableTLS }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">Enable TLS</span>
							</label>
						</div>
						<div class="mt-3">
							<label class="inline-flex items-center gap-2">
								<input type="checkbox" name="smtp_enable_request_notifications" value="on" {{ if .Notifications.SMTP.EnableRequestNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">New request notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="smtp_enable_approval_notifications" value="on" {{ if .Notifications.SMTP.EnableApprovalNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">Approval notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="smtp_enable_system_notifications" value="on" {{ if .Notifications.SMTP.EnableSystemNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">System notifications</span>
							</label>
						</div>
						<div class="mt-4 flex items-center gap-2">
							<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testSMTP()">Test Email</button>
							<span id="smtp_test" class="text-sm text-slate-400">—</span>
						</div>
					</div>

					<!-- Discord Provider -->
					<div id="discord_section" class="provider-section border border-white/10 rounded p-4 hidden">
						<div class="flex items-center gap-3 mb-3">
							<input type="checkbox" id="discord_enabled" name="discord_enabled" value="on" {{ if .Notifications.Discord.Enabled }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
							<label for="discord_enabled" class="font-medium text-slate-200">Enable Discord webhook notifications</label>
						</div>
						<div class="grid md:grid-cols-2 gap-3">
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Webhook URL</label>
								<input name="discord_webhook_url" placeholder="https://discord.com/api/webhooks/..." class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Discord.WebhookURL }}">
								<div class="text-xs text-slate-400 mt-1">Discord webhook URL for notifications</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-200 mb-1">Username (Optional)</label>
								<input name="discord_username" placeholder="Scriptorum" class="border border-white/10 bg-night-900 text-slate-100 rounded px-3 py-2 w-full" value="{{ .Notifications.Discord.Username }}">
								<div class="text-xs text-slate-400 mt-1">Bot username for Discord messages</div>
							</div>
						</div>
						<div class="mt-3">
							<label class="inline-flex items-center gap-2">
								<input type="checkbox" name="discord_enable_request_notifications" value="on" {{ if .Notifications.Discord.EnableRequestNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">New request notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="discord_enable_approval_notifications" value="on" {{ if .Notifications.Discord.EnableApprovalNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">Approval notifications</span>
							</label>
							<label class="inline-flex items-center gap-2 ml-4">
								<input type="checkbox" name="discord_enable_system_notifications" value="on" {{ if .Notifications.Discord.EnableSystemNotifications }}checked{{ end }} class="rounded border-white/10 bg-night-900 text-purple-600 focus:ring-purple-500">
								<span class="text-sm text-slate-300">System notifications</span>
							</label>
						</div>
						<div class="mt-4 flex items-center gap-2">
							<button type="button" class="px-3 py-1 rounded bg-royal-600 text-white hover:bg-royal-500" onclick="testDiscord()">Test Webhook</button>
							<span id="discord_test" class="text-sm text-slate-400">—</span>
						</div>
					</div>
					
				</div>
			</section>

			<div class="flex justify-end gap-3 mt-6">
				<button type="submit" class="px-4 py-2 bg-royal-600 text-white rounded hover:bg-royal-500 font-medium">Save Settings</button>
			</div>
		</form>
	</div>

	<script>
	// Enhanced provider selector UX
	(function() {
		const chips = document.querySelectorAll('.provider-chip');
		const sections = document.querySelectorAll('.provider-section');
		const emptyState = document.getElementById('empty_state');
		let currentProvider = '';

		function highlightChip(provider) {
			chips.forEach(btn => {
				btn.classList.remove('ring-1','ring-royal-500','bg-night-700');
				if (btn.dataset.provider === provider) {
					btn.classList.add('ring-1','ring-royal-500','bg-night-700');
				}
			});
		}

		function updateProviderUI() {
			sections.forEach(s => s.classList.add('hidden'));
			if (currentProvider) {
				const el = document.getElementById(currentProvider + '_section');
				if (el) el.classList.remove('hidden');
				emptyState.classList.add('hidden');
			} else {
				emptyState.classList.remove('hidden');
			}
			highlightChip(currentProvider);
		}

		// Wire events
		chips.forEach(btn => btn.addEventListener('click', (e) => {
			e.preventDefault();
			currentProvider = btn.dataset.provider;
			try { window.localStorage && localStorage.setItem('notifications.provider', currentProvider); } catch (_) {}
			updateProviderUI();
		}));

		// Initial selection: query param > saved selection > first enabled provider > ntfy
		const isEnabled = {
			ntfy: (document.getElementById('ntfy_enabled') && document.getElementById('ntfy_enabled').checked) || false,
			smtp: (document.getElementById('smtp_enabled') && document.getElementById('smtp_enabled').checked) || false,
			discord: (document.getElementById('discord_enabled') && document.getElementById('discord_enabled').checked) || false
		};
		const params = new URLSearchParams(window.location.search);
		let initial = params.get('provider');
		if (!['ntfy','smtp','discord'].includes(initial || '')) {
			const saved = (window.localStorage && localStorage.getItem('notifications.provider')) || '';
			if (['ntfy','smtp','discord'].includes(saved)) {
				initial = saved;
			}
		}
		if (!['ntfy','smtp','discord'].includes(initial || '')) {
			initial = (isEnabled.ntfy && 'ntfy') || (isEnabled.smtp && 'smtp') || (isEnabled.discord && 'discord') || 'ntfy';
		}
		currentProvider = initial || 'ntfy';
		updateProviderUI();

		// Minor CSS helpers (kept lightweight)
		const style = document.createElement('style');
		style.textContent = `
			.provider-section { transition: opacity 0.2s ease; }
			.provider-section.hidden { display: none; }
		`;
		document.head.appendChild(style);
	})();


function testNtfy() {
	const testSpan = document.getElementById('ntfy_test');
	const button = document.querySelector('button[onclick="testNtfy()"]');
	
	// Disable button and show loading state
	testSpan.textContent = 'Sending test...';
	testSpan.className = 'text-sm text-blue-400';
	button.disabled = true;
	button.classList.add('opacity-50', 'cursor-not-allowed');
	
	const form = document.querySelector('form');
	const formData = new FormData(form);
	
	// Build test request
	const testData = {
		server: formData.get('ntfy_server') || 'https://ntfy.sh',
		topic: formData.get('ntfy_topic') || 'test',
		username: formData.get('ntfy_username') || '',
		password: formData.get('ntfy_password') || ''
	};

	// Create abort controller for timeout
	const controller = new AbortController();
	const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
	
	fetch('/api/notifications/test-ntfy', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-Requested-With': 'XMLHttpRequest',
			'X-CSRF-Token': formData.get('_csrf_token')
		},
		body: JSON.stringify(testData),
		signal: controller.signal
	})
	.then(response => {
		clearTimeout(timeoutId);
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}`);
		}
		return response.json();
	})
	.then(data => {
		if (data.success) {
			testSpan.textContent = '✓ Test notification sent successfully!';
			testSpan.className = 'text-sm text-emerald-400';
		} else {
			testSpan.textContent = '✗ ' + (data.error || 'Test failed');
			testSpan.className = 'text-sm text-red-400';
		}
	})
	.catch(error => {
		clearTimeout(timeoutId);
		if (error.name === 'AbortError') {
			testSpan.textContent = '✗ Test timed out after 8 seconds';
		} else {
			testSpan.textContent = '✗ ' + (error.message || 'Network error');
		}
		testSpan.className = 'text-sm text-red-400';
	})
	.finally(() => {
		// Re-enable button and remove loading state
		button.disabled = false;
		button.classList.remove('opacity-50', 'cursor-not-allowed');
		
		// Reset status after 5 seconds
		setTimeout(() => {
			testSpan.textContent = '—';
			testSpan.className = 'text-sm text-slate-400';
		}, 5000);
	});
}

function testSMTP() {
	const testSpan = document.getElementById('smtp_test');
	const button = document.querySelector('button[onclick="testSMTP()"]');
	
	// Disable button and show loading state
	testSpan.textContent = 'Sending test email...';
	testSpan.className = 'text-sm text-blue-400';
	button.disabled = true;
	button.classList.add('opacity-50', 'cursor-not-allowed');
	
	const form = document.querySelector('form');
	const formData = new FormData(form);
	
	// Build test request
	const testData = {
		host: formData.get('smtp_host') || '',
		port: parseInt(formData.get('smtp_port')) || 587,
		username: formData.get('smtp_username') || '',
		password: formData.get('smtp_password') || '',
		from_email: formData.get('smtp_from_email') || '',
		from_name: formData.get('smtp_from_name') || 'Scriptorum Test',
		to_email: formData.get('smtp_to_email') || '',
		enable_tls: formData.get('smtp_enable_tls') === 'on'
	};

	// Create abort controller for timeout
	const controller = new AbortController();
	const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout for SMTP
	
	fetch('/api/notifications/test-smtp', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-Requested-With': 'XMLHttpRequest',
			'X-CSRF-Token': formData.get('_csrf_token')
		},
		body: JSON.stringify(testData),
		signal: controller.signal
	})
	.then(response => {
		clearTimeout(timeoutId);
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}`);
		}
		return response.json();
	})
	.then(data => {
		if (data.success) {
			testSpan.textContent = '✓ Test email sent successfully!';
			testSpan.className = 'text-sm text-emerald-400';
		} else {
			testSpan.textContent = '✗ ' + (data.error || 'Test failed');
			testSpan.className = 'text-sm text-red-400';
		}
	})
	.catch(error => {
		clearTimeout(timeoutId);
		if (error.name === 'AbortError') {
			testSpan.textContent = '✗ Test timed out after 15 seconds';
		} else {
			testSpan.textContent = '✗ ' + (error.message || 'Network error');
		}
		testSpan.className = 'text-sm text-red-400';
	})
	.finally(() => {
		// Re-enable button and remove loading state
		button.disabled = false;
		button.classList.remove('opacity-50', 'cursor-not-allowed');
		
		// Reset status after 5 seconds
		setTimeout(() => {
			testSpan.textContent = '—';
			testSpan.className = 'text-sm text-slate-400';
		}, 5000);
	});
}

function testDiscord() {
	const testSpan = document.getElementById('discord_test');
	const button = document.querySelector('button[onclick="testDiscord()"]');
	
	// Disable button and show loading state
	testSpan.textContent = 'Sending test message...';
	testSpan.className = 'text-sm text-blue-400';
	button.disabled = true;
	button.classList.add('opacity-50', 'cursor-not-allowed');
	
	const form = document.querySelector('form');
	const formData = new FormData(form);
	
	// Build test request
	const testData = {
		webhook_url: formData.get('discord_webhook_url') || '',
		username: formData.get('discord_username') || 'Scriptorum Test'
	};

	// Create abort controller for timeout
	const controller = new AbortController();
	const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
	
	fetch('/api/notifications/test-discord', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-Requested-With': 'XMLHttpRequest',
			'X-CSRF-Token': formData.get('_csrf_token')
		},
		body: JSON.stringify(testData),
		signal: controller.signal
	})
	.then(response => {
		clearTimeout(timeoutId);
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}`);
		}
		return response.json();
	})
	.then(data => {
		if (data.success) {
			testSpan.textContent = '✓ Test message sent successfully!';
			testSpan.className = 'text-sm text-emerald-400';
		} else {
			testSpan.textContent = '✗ ' + (data.error || 'Test failed');
			testSpan.className = 'text-sm text-red-400';
		}
	})
	.catch(error => {
		clearTimeout(timeoutId);
		if (error.name === 'AbortError') {
			testSpan.textContent = '✗ Test timed out after 10 seconds';
		} else {
			testSpan.textContent = '✗ ' + (error.message || 'Network error');
		}
		testSpan.className = 'text-sm text-red-400';
	})
	.finally(() => {
		// Re-enable button and remove loading state
		button.disabled = false;
		button.classList.remove('opacity-50', 'cursor-not-allowed');
		
		// Reset status after 5 seconds
		setTimeout(() => {
			testSpan.textContent = '—';
			testSpan.className = 'text-sm text-slate-400';
		}, 5000);
	});
}
</script>

{{ template "footer" . }}