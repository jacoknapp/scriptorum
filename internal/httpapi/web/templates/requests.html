{{ template "header" . }}
<div class="grid gap-4">
	<div class="flex items-center justify-between">
		<h1 class="text-xl font-semibold">Requests</h1>
	</div>
	<div id="req-table"
		 class="bg-night-800 rounded-xl2 shadow-card ring-1 ring-white/10 p-2"
		 hx-get="/ui/requests/table"
		 hx-trigger="load, request:created from:body, request:updated from:body, every 5s"
		 hx-swap="innerHTML">
		<div class="p-4 text-slate-400">Loadingâ€¦</div>
		{{/* Initial server render as a fallback; will be replaced by HTMX */}}
		{{ template "requests_table" . }}
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	formatRequestAuthors();
});

// Also format authors after HTMX updates the table
document.addEventListener('htmx:afterSwap', function(evt) {
	if (evt.detail.target && evt.detail.target.id === 'req-table') {
		formatRequestAuthors();
	}
});

function formatRequestAuthors() {
	// Format authors in desktop table
	var tableRows = document.querySelectorAll('#req-table table tbody tr');
	tableRows.forEach(function(row) {
		var authorElement = row.querySelector('td:first-child .text-slate-400');
		if (authorElement && authorElement.textContent.trim()) {
			var originalAuthor = authorElement.textContent.trim();
			if (originalAuthor && typeof window.formatAuthorName === 'function') {
				var formattedAuthor = window.formatAuthorName(originalAuthor);
				authorElement.textContent = formattedAuthor;
				
				// Also update the data-open-book JSON if it contains author info
				var clickableElement = row.querySelector('[data-open-book]');
				if (clickableElement) {
					try {
						var bookData = JSON.parse(clickableElement.getAttribute('data-open-book'));
						if (bookData.authors && bookData.authors.length > 0) {
							bookData.authors[0] = formattedAuthor;
							clickableElement.setAttribute('data-open-book', JSON.stringify(bookData));
						}
					} catch(e) {
						// Ignore JSON parsing errors
					}
				}
			}
		}
	});
	
	// Format authors in mobile cards  
	var mobileCards = document.querySelectorAll('#req-table .grid.gap-3 > div');
	mobileCards.forEach(function(card) {
		var authorElement = card.querySelector('.text-sm.text-slate-400');
		if (authorElement && authorElement.textContent.trim()) {
			var originalAuthor = authorElement.textContent.trim();
			if (originalAuthor && typeof window.formatAuthorName === 'function') {
				var formattedAuthor = window.formatAuthorName(originalAuthor);
				authorElement.textContent = formattedAuthor;
				
				// Also update the data-open-book JSON if it contains author info
				var clickableElement = card.querySelector('[data-open-book]');
				if (clickableElement) {
					try {
						var bookData = JSON.parse(clickableElement.getAttribute('data-open-book'));
						if (bookData.authors && bookData.authors.length > 0) {
							bookData.authors[0] = formattedAuthor;
							clickableElement.setAttribute('data-open-book', JSON.stringify(bookData));
						}
					} catch(e) {
						// Ignore JSON parsing errors
					}
				}
			}
		}
	});
}
</script>

{{ template "footer" . }}
