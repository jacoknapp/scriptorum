<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Scriptorum • Setup</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              royal: {50: '#f6f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95'}
            },
            boxShadow: { card: '0 8px 24px rgba(93,63,211,.12)' },
            borderRadius: { xl2: '1.25rem' }
          }
        }
      };
    </script>
    <meta name="theme-color" content="#7c3aed" />
    <link rel="icon" href="/static/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="/static/site.webmanifest">
  </head>
  <body class="bg-surface-50 text-slate-900">
    <div class="max-w-3xl mx-auto p-6">
      <div class="flex flex-col items-center mb-4">
        <img src="/static/icon.svg" class="w-20 h-20 mb-2"/>
        <h1 class="text-2xl font-semibold text-royal-700">Scriptorum — Initial Setup</h1>
        <p class="text-sm text-slate-600 mt-2 text-center">This guided wizard will walk you through the essential settings to get Scriptorum running. You can save progress on each step.</p>
      </div>

      <div id="stepper" class="bg-white rounded-xl2 shadow-card">
        <div class="p-4 border-b">
          <div class="flex items-center justify-between">
            <div class="text-sm text-slate-500">Configuration</div>
            <div class="text-sm text-slate-600" id="step-counter" aria-live="polite">Step 1 of 4</div>
          </div>
          <div class="w-full bg-slate-100 h-2 rounded mt-3 overflow-hidden">
            <div id="step-progress" class="bg-royal-500 h-2 w-1/4"></div>
          </div>
        </div>

        <div id="step-body" hx-get="/setup/step/1" hx-trigger="load" class="p-4" aria-live="polite">Loading setup step…</div>

        <div class="flex items-center justify-between border-t p-3">
          <button id="btn-prev" class="px-3 py-1.5 rounded-lg bg-white text-royal-700 ring-1 ring-royal-200 disabled:opacity-50" disabled>Previous</button>
          <div class="flex items-center gap-3">
            <span id="gate-note" class="text-sm text-slate-500" aria-live="polite">Please complete required fields and save this step before continuing.</span>
            <button id="btn-next" class="px-4 py-2 rounded-lg bg-royal-600 text-white disabled:opacity-50" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let step = 1, maxStep = 4;
      const body = document.getElementById('step-body');
      const prev = document.getElementById('btn-prev');
      const next = document.getElementById('btn-next');
      const note = document.getElementById('gate-note');
      const counter = document.getElementById('step-counter');
      const progress = document.getElementById('step-progress');

      function updateProgress() {
        counter.textContent = `Step ${step} of ${maxStep}`;
        const pct = Math.round((step / maxStep) * 100);
        progress.style.width = pct + '%';
      }

      function refreshGate(){
        fetch('/setup/can-advance/' + step)
          .then(r => r.json())
          .then(j => {
            const ok = j.ok === true;
            next.disabled = !ok;
            note.textContent = ok ? 'All good — you may continue.' : 'Please complete required fields and save this step before continuing.';
            next.textContent = (step === maxStep ? 'Finish' : 'Next');
          })
          .catch(() => {
            note.textContent = 'Unable to check step status — try saving.';
          });
      }

      function loadStep(n){
        step = n;
        body.setAttribute('hx-get','/setup/step/' + step);
        htmx.ajax('GET','/setup/step/' + step, { target: body, swap: 'innerHTML' });
        prev.disabled = (step === 1);
        updateProgress();
        refreshGate();
      }

      prev.onclick = () => loadStep(Math.max(1, step - 1));
      next.onclick = () => {
        if (step < maxStep) {
          fetch('/setup/can-advance/' + step).then(r => r.json()).then(j => { if (j.ok) loadStep(step + 1); });
        } else {
          fetch('/setup/finish',{method:'POST'}).then(async r => {
            if (r.ok) location.href = '/';
            else alert(await r.text());
          });
        }
      };

      htmx.on('setup-saved', () => refreshGate());

      // initialize UI
      updateProgress();
      refreshGate();
    </script>
  </body>
</html>